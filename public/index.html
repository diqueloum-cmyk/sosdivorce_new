<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Divorce en ligne : Conseil juridique IA et avocat sp√©cialis√© | sosdivorce.fr</title>
  <meta name="description" content="Obtenez des conseils juridiques instantan√©s pour votre divorce avec notre IA sp√©cialis√©e. Acc√®s direct √† des avocats qualifi√©s √† tarif pr√©f√©rentiel." />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Stripe.js for payment -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .typing-cursor { animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    /* Hide sections */
    .section-hidden { display: none !important; }

    /* Payment buttons style */
    .offer-button {
      transition: all 0.2s ease-in-out;
    }
    .offer-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .offer-button.selected {
      border-color: #2563eb;
      background-color: #eff6ff;
    }

    /* Maintenance overlay */
    #maintenanceOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #maintenanceOverlay.hidden {
      display: none;
    }
    .maintenance-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .maintenance-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .maintenance-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
      letter-spacing: 4px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .maintenance-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .maintenance-input.error {
      border-color: #ef4444;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .maintenance-btn {
      width: 100%;
      padding: 12px 24px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .maintenance-btn:hover {
      background: #1d4ed8;
    }
    .maintenance-error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }
  </style>
</head>
<body class="bg-white text-gray-800">

  <!-- Maintenance Overlay (hidden by default, shown only if maintenance is enabled) -->
  <div id="maintenanceOverlay" class="hidden">
    <div class="maintenance-box">
      <div class="maintenance-icon">üîß</div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Site en maintenance</h2>
      <p class="text-gray-600 mb-6">Entrez le code d'acc√®s pour continuer</p>
      <input
        type="password"
        id="maintenanceCode"
        class="maintenance-input"
        placeholder="Code d'acc√®s"
        maxlength="9"
        autocomplete="off"
      >
      <button onclick="checkMaintenanceCode()" class="maintenance-btn">Acc√©der au site</button>
      <p id="maintenanceError" class="maintenance-error">Code incorrect. Veuillez r√©essayer.</p>
    </div>
  </div>

  <!-- Cookie Banner and Modal will be created dynamically by cookies.js -->

  <!-- Header -->
  <header class="bg-blue-900 text-white p-3 md:p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center gap-2">
      <div class="whitespace-nowrap">
        <span class="font-bold text-xl md:text-3xl">SOS</span><span class="font-bold text-sm md:text-xl">DIVORCE.FR</span>
      </div>
      <nav id="mainNav" class="hidden md:flex space-x-6">
        <a href="#about">√Ä propos</a>
        <a href="#features">Services</a>
        <a href="#pricing">Tarifs</a>
        <a href="#testimonials">T√©moignages</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <main>
  <section id="heroSection" class="bg-blue-50 py-16 px-4">
    <div class="max-w-6xl mx-auto">
      <!-- Titre centr√© en haut -->
      <h1 class="text-3xl font-bold text-blue-900 mb-8 text-center">
        <span class="font-bold text-3xl">SOS</span><span class="font-bold text-xl">DIVORCE.FR</span> associe IA juridique et avocats sp√©cialis√©s pour vous accompagner dans votre divorce.
      </h1>

      <!-- Vid√©o et texte c√¥te √† c√¥te -->
      <div class="flex flex-col md:flex-row items-stretch gap-8">
        <div class="md:w-1/2">
          <video autoplay loop muted playsinline poster="logo-sosdivorce.png" class="w-full h-full min-h-80 object-cover rounded-lg shadow-lg">
            <source src="logo-sosdivorce.mp4" type="video/mp4">
            <img src="logo-sosdivorce.png" alt="sosdivorce.fr - Conseil juridique divorce en ligne" class="w-full h-full min-h-80 object-cover rounded-lg shadow-lg">
          </video>
        </div>
        <div class="md:w-1/2 flex flex-col justify-center text-left">
          <p class="text-lg text-gray-600 mb-6">Notre assistant IA analyse votre situation en quelques questions et pr√©pare une synth√®se personnalis√©e.</p>
          <p class="text-lg text-gray-600 mb-6">Vous obtiendrez :</p>
          <div class="space-y-3">
            <div class="flex items-center space-x-2">
              <span>‚û°Ô∏è Une analyse personnalis√©e de votre situation,</span>
            </div>
            <div class="flex items-center space-x-2">
              <span>‚û°Ô∏è Un diagnostic juridique adapt√© √† votre cas,</span>
            </div>
            <div class="flex items-center space-x-2">
              <span>‚û°Ô∏è Des recommandations concr√®tes pour la suite.</span>
            </div>
          </div>
          <p class="text-lg text-gray-600 mt-6">üîí Service confidentiel et s√©curis√©.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Chatbot Section -->
  <section id="chatSection" class="py-16 px-4 bg-white">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">Commencez votre diagnostic</h2>

      <div class="bg-gray-50 rounded-lg p-3 md:p-6 shadow-lg">
        <!-- Chat Header -->
        <div class="chat-header mb-4 pb-3 border-b border-gray-200">
          <h3 class="font-semibold text-gray-800 text-lg">Assistant SOS Divorce</h3>
          <p class="text-sm text-gray-500">R√©pondez √† quelques questions pour obtenir votre analyse personnalis√©e</p>
        </div>

        <!-- Chat Messages -->
        <div id="chatContainer" class="space-y-4 mb-4" style="max-height: 450px; overflow-y: auto;">
          <div class="text-center text-gray-500 py-4">
            <p class="text-sm">Chargement de l'assistant...</p>
          </div>
        </div>

        <!-- Chat Input -->
        <div id="chatInputArea" class="flex space-x-2">
          <input type="text" id="userInput" placeholder="Votre r√©ponse..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
          <button onclick="sendMessage()" id="sendButton" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors min-w-[48px] flex-shrink-0">
            <span id="sendBtnText">
              <span class="hidden max-[500px]:inline">‚Üë</span>
              <span class="max-[500px]:hidden">Envoyer</span>
            </span>
            <span id="loadingBtnText" class="hidden">
              <span class="hidden max-[500px]:inline">...</span>
              <span class="max-[500px]:hidden">Envoi...</span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Payment Section (hidden by default) -->
  <section id="paymentSection" class="py-16 px-4 bg-white section-hidden">
    <div class="max-w-lg mx-auto">
      <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold text-blue-900 mb-6 text-center">Paiement s√©curis√©</h2>

        <!-- Payment Info -->
        <div class="payment-info mb-6 p-4 bg-blue-50 rounded-lg">
          <div class="flex justify-between items-center mb-2">
            <span class="text-gray-700">Formule choisie :</span>
            <strong id="selectedExpertiseName" class="text-blue-900">-</strong>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-700">Montant :</span>
            <strong id="selectedPriceDisplay" class="text-blue-900 text-xl">-</strong>
          </div>
        </div>

        <!-- Stripe Payment Element -->
        <div id="payment-element" class="mb-6"></div>

        <!-- Payment Error Message -->
        <div id="payment-message" class="hidden text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-lg"></div>

        <!-- Payment Buttons -->
        <div class="flex gap-4">
          <button onclick="backToChat()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition-colors">
            Retour
          </button>
          <button onclick="handlePayment()" id="submitPaymentBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
            Payer maintenant
          </button>
        </div>

        <!-- Security Badge -->
        <div class="mt-6 text-center">
          <p class="text-xs text-gray-500">üîí Paiement s√©curis√© par Stripe</p>
        </div>
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about" class="py-16 px-4 bg-gray-50">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">√Ä Propos de Notre Service</h2>
      <div class="text-center max-w-4xl mx-auto">
        <p class="text-lg text-gray-600 mb-6">
          Nous combinons la puissance de l'intelligence artificielle avec l'expertise de juristes sp√©cialis√©s pour vous accompagner sereinement √† chaque √©tape de votre divorce.
        </p>
      </div>
    </div>
  </section>

  <!-- Features Section -->
  <section id="features" class="py-16 px-4 bg-white">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">Nos Services</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="text-center p-6 bg-blue-50 rounded-lg">
          <div class="text-4xl mb-4">ü§ñ</div>
          <h3 class="text-xl font-bold text-blue-900 mb-3">IA Juridique Sp√©cialis√©e</h3>
          <p class="text-gray-600">Diagnostic personnalis√© bas√© sur l'analyse de votre situation en quelques minutes.</p>
        </div>
        <div class="text-center p-6 bg-green-50 rounded-lg">
          <div class="text-4xl mb-4">üë®‚Äç‚öñÔ∏è</div>
          <h3 class="text-xl font-bold text-green-900 mb-3">Analyse Expert</h3>
          <p class="text-gray-600">Recevez une analyse d√©taill√©e valid√©e par des professionnels du droit.</p>
        </div>
        <div class="text-center p-6 bg-purple-50 rounded-lg">
          <div class="text-4xl mb-4">üîí</div>
          <h3 class="text-xl font-bold text-purple-900 mb-3">Confidentialit√© Totale</h3>
          <p class="text-gray-600">Vos √©changes sont s√©curis√©s et confidentiels. Nous respectons votre vie priv√©e.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Pricing Section -->
  <section id="pricing" class="py-16 px-4 bg-gray-50">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">Nos Formules</h2>

      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Analyse Express -->
        <div class="bg-white p-8 rounded-lg shadow-lg border-2 border-gray-200">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-blue-900 mb-2">Analyse Express</h3>
            <div class="text-4xl font-bold text-blue-600">29‚Ç¨</div>
          </div>
          <ul class="space-y-3 mb-6">
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Diagnostic de votre situation</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Points cl√©s identifi√©s</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Recommandations de base</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Livraison par email</span>
            </li>
          </ul>
        </div>

        <!-- Analyse Premium -->
        <div class="bg-white p-8 rounded-lg shadow-lg border-2 border-blue-500 relative">
          <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
            <span class="bg-blue-500 text-white px-4 py-1 rounded-full text-sm font-semibold">Recommand√©</span>
          </div>
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-blue-900 mb-2">Analyse Premium</h3>
            <div class="text-4xl font-bold text-blue-600">49‚Ç¨</div>
            <p class="text-sm text-gray-500">valid√©e avocat</p>
          </div>
          <ul class="space-y-3 mb-6">
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Tout de l'Analyse Express</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Analyse approfondie d√©taill√©e</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Validation par un avocat</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Recommandations personnalis√©es</span>
            </li>
            <li class="flex items-start">
              <span class="text-green-500 mr-2">‚úì</span>
              <span>Exemples concrets</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Testimonials Section -->
  <section id="testimonials" class="py-16 px-4 bg-white">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">T√©moignages</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"Service exceptionnel ! J'ai eu des r√©ponses claires et une analyse compl√®te de ma situation."</p>
          <div class="font-bold text-blue-900">Marie L.</div>
        </div>
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"L'analyse premium m'a permis d'y voir clair sur mes droits et les √©tapes √† suivre."</p>
          <div class="font-bold text-blue-900">Pierre M.</div>
        </div>
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"Rapide, confidentiel et tr√®s professionnel. Je recommande vivement."</p>
          <div class="font-bold text-blue-900">Sophie D.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section id="faq" class="py-16 px-4 bg-gray-50">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">Questions Fr√©quentes</h2>
      <div class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Comment fonctionne le diagnostic ?</h3>
          <p class="text-gray-600">Notre assistant IA vous pose quelques questions sur votre situation. En quelques minutes, il analyse vos r√©ponses et pr√©pare un diagnostic personnalis√©.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Les informations sont-elles confidentielles ?</h3>
          <p class="text-gray-600">Absolument. Tous vos √©changes sont chiffr√©s et confidentiels. Nous ne partageons aucune information personnelle.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Quelle est la diff√©rence entre Express et Premium ?</h3>
          <p class="text-gray-600">L'analyse Express donne les points cl√©s de votre situation. L'analyse Premium va plus loin avec une validation par avocat et des recommandations d√©taill√©es.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Comment recevoir mon analyse ?</h3>
          <p class="text-gray-600">Apr√®s paiement, votre analyse est envoy√©e par email √† l'adresse que vous avez fournie pendant le questionnaire.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section id="contact" class="py-16 px-4 bg-blue-900 text-white">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-3xl font-bold mb-8">Contactez-Nous</h2>
      <p class="text-xl mb-8">Une question ? Besoin d'aide ? Notre √©quipe est l√† pour vous.</p>
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4">Informations</h3>
          <p class="mb-2">üìß contact@sosdivorce.fr</p>
          <p>üïí Lun-Ven 9h-18h</p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Support</h3>
          <p class="mb-2">üí¨ Chat en ligne</p>
          <p class="mb-2">üìß support@sosdivorce.fr</p>
          <p>üì± R√©ponse sous 24h</p>
        </div>
      </div>
    </div>
  </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 px-4">
    <div class="max-w-6xl mx-auto text-center">
      <div class="mb-4">
        <span class="font-bold text-2xl">SOS</span><span class="font-bold text-lg">DIVORCE.FR</span>
      </div>
      <p class="text-gray-400 mb-4">Conseil juridique divorce en ligne avec IA et avocat sp√©cialis√©</p>

      <!-- Liens l√©gaux -->
      <div class="flex flex-wrap justify-center gap-4 mb-6 text-sm">
        <a href="/cgv.html" class="text-gray-400 hover:text-white transition-colors">Conditions G√©n√©rales de Vente</a>
        <span class="text-gray-600">|</span>
        <a href="/mentions-legales.html" class="text-gray-400 hover:text-white transition-colors">Mentions L√©gales</a>
        <span class="text-gray-600">|</span>
        <a href="/politique-confidentialite.html" class="text-gray-400 hover:text-white transition-colors">Politique de Confidentialit√©</a>
        <span class="text-gray-600">|</span>
        <a href="/politique-cookies.html" class="text-gray-400 hover:text-white transition-colors">Politique Cookies</a>
        <span class="text-gray-600">|</span>
        <a href="/politique-rgpd.html" class="text-gray-400 hover:text-white transition-colors">Politique RGPD</a>
      </div>

      <!-- Bouton G√©rer mes cookies -->
      <div class="mb-4">
        <button onclick="showCookiePreferences()" class="text-gray-400 hover:text-white transition-colors text-sm underline">
          üç™ G√©rer mes pr√©f√©rences de cookies
        </button>
      </div>

      <div class="mt-6 text-sm text-gray-400">
        <p>&copy; 2024 sosdivorce.fr - Tous droits r√©serv√©s</p>
      </div>
    </div>
  </footer>

  <script>
    // ====================================
    // MAINTENANCE MODE
    // ====================================
    const MAINTENANCE_CODE = '789654123';

    // V√©rifier l'√©tat de maintenance depuis le serveur
    async function checkMaintenanceFromServer() {
      try {
        const response = await fetch('/api/maintenance');
        const data = await response.json();

        if (data.success && data.maintenanceEnabled) {
          // Mode maintenance activ√© - retourner true
          return true;
        }
        return false; // Maintenance d√©sactiv√©e
      } catch (error) {
        console.log('Erreur v√©rification maintenance, site accessible par d√©faut');
        return false; // En cas d'erreur, laisser le site accessible
      }
    }

    // V√©rifier si l'acc√®s est d√©j√† autoris√© (local)
    async function checkMaintenanceAccess() {
      // D'abord v√©rifier si la maintenance est activ√©e c√¥t√© serveur
      const maintenanceEnabled = await checkMaintenanceFromServer();

      if (!maintenanceEnabled) {
        // Maintenance d√©sactiv√©e c√¥t√© serveur - site accessible, overlay reste cach√©
        return;
      }

      // Maintenance activ√©e - v√©rifier si l'utilisateur a d√©j√† le code
      const accessGranted = sessionStorage.getItem('maintenance_access');
      if (accessGranted === 'granted') {
        // L'utilisateur a d√©j√† entr√© le code - laisser l'overlay cach√©
        return;
      }

      // Maintenance activ√©e et pas d'acc√®s - afficher l'overlay
      document.getElementById('maintenanceOverlay').classList.remove('hidden');
    }

    // V√©rifier le code de maintenance
    function checkMaintenanceCode() {
      const input = document.getElementById('maintenanceCode');
      const errorMsg = document.getElementById('maintenanceError');
      const code = input.value.trim();

      if (code === MAINTENANCE_CODE) {
        // Code correct - autoriser l'acc√®s
        sessionStorage.setItem('maintenance_access', 'granted');
        document.getElementById('maintenanceOverlay').classList.add('hidden');
      } else {
        // Code incorrect - afficher l'erreur
        input.classList.add('error');
        errorMsg.style.display = 'block';

        setTimeout(() => {
          input.classList.remove('error');
        }, 500);
      }
    }

    // Permettre de valider avec Entr√©e
    document.addEventListener('DOMContentLoaded', function() {
      const maintenanceInput = document.getElementById('maintenanceCode');
      if (maintenanceInput) {
        maintenanceInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            checkMaintenanceCode();
          }
        });
      }

      // V√©rifier l'acc√®s au chargement
      checkMaintenanceAccess();
    });

    // ====================================
    // CONFIGURATION
    // ====================================
    const CONFIG = {
      stripePublicKey: 'pk_test_51SrNCkPw4xvsWxrUnYCrm3Z6C8015jgyI6GBbePy3vi0Wm4Z5IUtX9GwiP8CP5loolhCryPGu7zlzFDtorLBwMSn00NNubWeUU',
      expertisePrices: {
        classique: 2900, // 29‚Ç¨ en centimes
        premium: 4900    // 49‚Ç¨ en centimes
      },
      expertiseNames: {
        classique: 'Analyse Express',
        premium: 'Analyse Premium valid√©e avocat'
      }
    };

    // ====================================
    // STATE
    // ====================================
    let state = {
      sessionId: null,
      selectedExpertise: null,
      selectedPrice: 0,
      stripe: null,
      elements: null,
      paymentElement: null,
      isProcessing: false,
      waitingForComments: false,
      readyForPayment: false
    };

    // ====================================
    // INITIALIZATION
    // ====================================
    document.addEventListener('DOMContentLoaded', function() {
      initChatSession();
    });

    // Initialiser la session de chat
    async function initChatSession() {
      try {
        // Cr√©er une nouvelle session
        const response = await fetch('/api/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success && data.sessionId) {
          state.sessionId = data.sessionId;
          console.log('Session cr√©√©e:', state.sessionId);

          // Envoyer le message [INIT] pour d√©marrer le questionnaire
          await sendInitMessage();
        } else {
          throw new Error(data.error || 'Erreur lors de la cr√©ation de la session');
        }
      } catch (error) {
        console.error('Erreur initialisation session:', error);
        document.getElementById('chatContainer').innerHTML = `
          <div class="text-center text-red-500 py-4">
            <p class="text-sm">Erreur de connexion. Veuillez rafra√Æchir la page.</p>
          </div>
        `;
      }
    }

    // Envoyer le message [INIT] pour d√©marrer le questionnaire
    async function sendInitMessage() {
      try {
        document.getElementById('chatContainer').innerHTML = `
          <div class="text-center text-gray-500 py-4">
            <p class="text-sm">Chargement de l'assistant...</p>
          </div>
        `;

        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            sessionId: state.sessionId,
            message: '[INIT]'
          })
        });

        const data = await response.json();

        if (data.success && data.response) {
          // Vider le conteneur et afficher la premi√®re question
          document.getElementById('chatContainer').innerHTML = '';
          addMessage(data.response, 'assistant');
        } else {
          throw new Error(data.error || 'Erreur lors du d√©marrage');
        }
      } catch (error) {
        console.error('Erreur envoi [INIT]:', error);
        document.getElementById('chatContainer').innerHTML = `
          <div class="text-center text-red-500 py-4">
            <p class="text-sm">Erreur de d√©marrage. Veuillez rafra√Æchir la page.</p>
          </div>
        `;
      }
    }

    // ====================================
    // CHAT FUNCTIONS
    // ====================================

    // Envoyer un message
    async function sendMessage() {
      if (state.isProcessing) return;

      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();

      if (!message) return;

      // Marquer comme en cours
      state.isProcessing = true;
      setButtonLoading(true);

      // Afficher le message utilisateur
      addMessage(message, 'user');
      userInput.value = '';

      // Afficher l'indicateur de chargement
      const loadingId = addMessage('R√©flexion en cours...', 'assistant', true);

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            sessionId: state.sessionId,
            message: message
          })
        });

        removeMessage(loadingId);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erreur serveur');
        }

        const data = await response.json();

        if (data.success && data.response) {
          // Traiter la r√©ponse
          processAssistantResponse(data.response);
        } else {
          throw new Error(data.error || 'Erreur lors de la g√©n√©ration de la r√©ponse');
        }

      } catch (error) {
        removeMessage(loadingId);
        removeAllLoadingIndicators(); // S√©curit√© suppl√©mentaire
        addMessage('Erreur: ' + error.message + '. Veuillez r√©essayer.', 'assistant');
      } finally {
        state.isProcessing = false;
        setButtonLoading(false);
      }
    }

    // Traiter la r√©ponse de l'assistant
    function processAssistantResponse(response) {
      // D√©tecter si la r√©ponse contient une proposition de paiement (29‚Ç¨ et 49‚Ç¨)
      const containsPaymentProposal = (response.includes('29') && response.includes('49')) ||
                                      (response.includes('Express') && response.includes('Premium'));

      // D√©tecter si c'est le moment de payer (apr√®s les commentaires)
      const containsPaymentReady = response.includes('[PAIEMENT_PRET]');

      if (containsPaymentReady) {
        // Nettoyer le tag et afficher le message avec le bouton final
        const cleanResponse = response.replace('[PAIEMENT_PRET]', '').trim();
        addMessage(cleanResponse, 'assistant');
        addFinalPaymentButton();
        state.readyForPayment = true;
      } else if (containsPaymentProposal && !state.selectedExpertise) {
        // Afficher le message et les boutons de s√©lection d'offre
        addMessage(response, 'assistant');
        addOfferSelectionButtons();
      } else {
        // Message normal
        addTypingMessage(response);
      }
    }

    // Ajouter les boutons de s√©lection d'offre
    function addOfferSelectionButtons() {
      const chatContainer = document.getElementById('chatContainer');
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'flex flex-col sm:flex-row gap-3 my-4';
      buttonsDiv.id = 'offerButtons';

      buttonsDiv.innerHTML = `
        <button onclick="selectOffer('classique')" class="offer-button flex-1 bg-white border-2 border-blue-200 text-blue-900 px-4 py-3 rounded-lg hover:border-blue-500 transition-all">
          <span class="font-semibold">üí≥ Analyse Express</span><br>
          <span class="text-lg font-bold">29‚Ç¨</span>
        </button>
        <button onclick="selectOffer('premium')" class="offer-button flex-1 bg-blue-50 border-2 border-blue-500 text-blue-900 px-4 py-3 rounded-lg hover:bg-blue-100 transition-all">
          <span class="font-semibold">üí≥ Analyse Premium</span><br>
          <span class="text-lg font-bold">49‚Ç¨</span>
          <span class="block text-xs text-blue-600">Recommand√©</span>
        </button>
      `;

      chatContainer.appendChild(buttonsDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // S√©lectionner une offre
    async function selectOffer(expertise) {
      state.selectedExpertise = expertise;
      state.selectedPrice = CONFIG.expertisePrices[expertise];
      state.waitingForComments = true;

      // Supprimer les boutons d'offre
      const offerButtons = document.getElementById('offerButtons');
      if (offerButtons) offerButtons.remove();

      // Afficher le choix de l'utilisateur
      const offerName = CONFIG.expertiseNames[expertise];
      addMessage(`J'ai choisi l'offre ${offerName} (${state.selectedPrice / 100}‚Ç¨)`, 'user');

      // Afficher l'indicateur de chargement
      const loadingId = addMessage('R√©flexion en cours...', 'assistant', true);
      state.isProcessing = true;
      setButtonLoading(true);

      try {
        // Envoyer le message de choix d'offre
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            sessionId: state.sessionId,
            message: `[CHOIX_OFFRE:${expertise}] J'ai choisi l'offre ${offerName}`
          })
        });

        removeMessage(loadingId);

        const data = await response.json();

        if (data.success && data.response) {
          // L'assistant va demander les commentaires personnels
          addTypingMessage(data.response);
        } else {
          throw new Error(data.error || 'Erreur');
        }

      } catch (error) {
        removeMessage(loadingId);
        removeAllLoadingIndicators(); // S√©curit√© suppl√©mentaire
        addMessage('Erreur: ' + error.message, 'assistant');
      } finally {
        state.isProcessing = false;
        setButtonLoading(false);
      }
    }

    // Ajouter le bouton de paiement final
    function addFinalPaymentButton() {
      const chatContainer = document.getElementById('chatContainer');
      const buttonDiv = document.createElement('div');
      buttonDiv.className = 'my-4';
      buttonDiv.id = 'finalPaymentButton';

      const offerName = CONFIG.expertiseNames[state.selectedExpertise];
      const price = state.selectedPrice / 100;

      buttonDiv.innerHTML = `
        <button onclick="initiatePayment()" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 transition-colors font-semibold text-lg">
          üí≥ Proc√©der au paiement - ${offerName} (${price}‚Ç¨)
        </button>
      `;

      chatContainer.appendChild(buttonDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ====================================
    // PAYMENT FUNCTIONS
    // ====================================

    // Initier le paiement
    async function initiatePayment() {
      try {
        // Masquer la section chat et afficher la section paiement
        showSection('paymentSection');

        // Mettre √† jour l'affichage
        document.getElementById('selectedExpertiseName').textContent = CONFIG.expertiseNames[state.selectedExpertise];
        document.getElementById('selectedPriceDisplay').textContent = (state.selectedPrice / 100) + '‚Ç¨';

        // Cr√©er l'intention de paiement
        const response = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            sessionId: state.sessionId,
            expertise: state.selectedExpertise,
            amount: state.selectedPrice
          })
        });

        const data = await response.json();

        if (!data.success || !data.clientSecret) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation du paiement');
        }

        // Initialiser Stripe
        state.stripe = Stripe(CONFIG.stripePublicKey);
        state.elements = state.stripe.elements({
          clientSecret: data.clientSecret,
          appearance: {
            theme: 'stripe',
            variables: {
              colorPrimary: '#2563eb'
            }
          }
        });

        // Cr√©er et monter le Payment Element
        state.paymentElement = state.elements.create('payment');
        state.paymentElement.mount('#payment-element');

      } catch (error) {
        console.error('Erreur initiation paiement:', error);
        showPaymentError(error.message);
      }
    }

    // G√©rer le paiement
    async function handlePayment() {
      if (!state.stripe || !state.elements) {
        showPaymentError('Le formulaire de paiement n\'est pas pr√™t. Veuillez rafra√Æchir la page.');
        return;
      }

      const submitButton = document.getElementById('submitPaymentBtn');
      submitButton.disabled = true;
      submitButton.textContent = 'Traitement en cours...';

      try {
        const { error, paymentIntent } = await state.stripe.confirmPayment({
          elements: state.elements,
          confirmParams: {
            return_url: window.location.href
          },
          redirect: 'if_required'
        });

        if (error) {
          throw new Error(error.message);
        }

        if (paymentIntent && paymentIntent.status === 'succeeded') {
          // V√©rifier le paiement c√¥t√© serveur
          await verifyPayment(paymentIntent.id);
        }

      } catch (error) {
        console.error('Erreur paiement:', error);
        showPaymentError(error.message);
        submitButton.disabled = false;
        submitButton.textContent = 'Payer maintenant';
      }
    }

    // V√©rifier le paiement
    async function verifyPayment(paymentIntentId) {
      try {
        const response = await fetch('/api/verify-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            sessionId: state.sessionId,
            paymentIntentId: paymentIntentId
          })
        });

        const data = await response.json();

        if (data.success) {
          // Paiement confirm√© - Retourner au chat avec message de confirmation
          showSection('chatSection');

          // Supprimer le bouton de paiement final
          const finalPaymentButton = document.getElementById('finalPaymentButton');
          if (finalPaymentButton) finalPaymentButton.remove();

          // Afficher le message de confirmation
          addMessage(`‚úÖ Paiement confirm√© ! Votre ${CONFIG.expertiseNames[state.selectedExpertise]} sera envoy√©e √† l'adresse email que vous avez fournie. Merci pour votre confiance !`, 'assistant');

          // D√©sactiver l'input (fin de la conversation)
          document.getElementById('userInput').disabled = true;
          document.getElementById('userInput').placeholder = 'Conversation termin√©e - Merci !';
          document.getElementById('sendButton').disabled = true;

        } else {
          throw new Error(data.error || 'Erreur de v√©rification du paiement');
        }

      } catch (error) {
        console.error('Erreur v√©rification paiement:', error);
        showPaymentError(error.message);
      }
    }

    // Afficher une erreur de paiement
    function showPaymentError(message) {
      const errorDiv = document.getElementById('payment-message');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    // Retourner au chat
    function backToChat() {
      showSection('chatSection');

      // Nettoyer le formulaire de paiement
      if (state.paymentElement) {
        state.paymentElement.destroy();
        state.paymentElement = null;
      }
      state.elements = null;

      // Masquer l'erreur
      document.getElementById('payment-message').classList.add('hidden');
    }

    // ====================================
    // UI HELPERS
    // ====================================

    // Afficher une section (chat ou paiement)
    function showSection(sectionId) {
      document.getElementById('chatSection').classList.toggle('section-hidden', sectionId !== 'chatSection');
      document.getElementById('paymentSection').classList.toggle('section-hidden', sectionId !== 'paymentSection');
    }

    // Compteur pour garantir des IDs uniques
    let messageCounter = 0;

    // Ajouter un message au chat
    function addMessage(message, sender, isLoading = false) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      const messageId = 'msg_' + Date.now() + '_' + (++messageCounter);

      messageDiv.id = messageId;
      messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

      const messageContent = document.createElement('div');
      messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg whitespace-pre-line ${
        sender === 'user'
          ? 'bg-blue-600 text-white'
          : 'bg-gray-200 text-gray-800'
      }`;

      if (isLoading) {
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        const cursorSpan = document.createElement('span');
        cursorSpan.className = 'typing-cursor';
        cursorSpan.textContent = '|';
        messageContent.appendChild(textSpan);
        messageContent.appendChild(cursorSpan);
      } else {
        messageContent.textContent = message;
      }

      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return messageId;
    }

    // Supprimer un message
    function removeMessage(messageId) {
      if (!messageId) return;
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // Supprimer tous les indicateurs de chargement (s√©curit√©)
    function removeAllLoadingIndicators() {
      const chatContainer = document.getElementById('chatContainer');
      const loadingMessages = chatContainer.querySelectorAll('.typing-cursor');
      loadingMessages.forEach(cursor => {
        const messageDiv = cursor.closest('.flex');
        if (messageDiv && messageDiv.id && messageDiv.id.startsWith('msg_')) {
          messageDiv.remove();
        }
      });
    }

    // Ajouter un message avec effet de frappe
    function addTypingMessage(text) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');

      messageDiv.className = 'flex justify-start';

      const messageContent = document.createElement('div');
      messageContent.className = 'max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-200 text-gray-800 whitespace-pre-line';

      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);

      const textSpan = document.createElement('span');
      const cursorSpan = document.createElement('span');
      cursorSpan.className = 'typing-cursor';
      cursorSpan.textContent = '|';

      messageContent.appendChild(textSpan);
      messageContent.appendChild(cursorSpan);

      let i = 0;
      const typingInterval = setInterval(() => {
        if (i < text.length) {
          textSpan.textContent = text.substring(0, i + 1);
          i++;
        } else {
          textSpan.textContent = text;
          cursorSpan.remove();
          clearInterval(typingInterval);
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 20);
    }

    // G√©rer l'√©tat du bouton d'envoi
    function setButtonLoading(isLoading) {
      document.getElementById('sendBtnText').classList.toggle('hidden', isLoading);
      document.getElementById('loadingBtnText').classList.toggle('hidden', !isLoading);
    }

    // Permettre d'envoyer avec Entr√©e
    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>

  <!-- Cookie Management -->
  <script src="/js/cookies.js"></script>

</body>
</html>
