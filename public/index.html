<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Divorce en ligne : Conseil juridique IA et avocat sp√©cialis√© | sosdivorce.fr</title>
  <meta name="description" content="Obtenez des conseils juridiques instantan√©s pour votre divorce avec notre IA sp√©cialis√©e. Acc√®s direct √† des avocats qualifi√©s √† tarif pr√©f√©rentiel." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .typing-cursor { animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    /* Conversation History Styles */
    .conversation-sidebar {
      transition: transform 0.3s ease-in-out;
    }
    .conversation-item {
      transition: background-color 0.2s;
    }
    .conversation-item:hover {
      background-color: #f3f4f6;
    }
    .conversation-item.active {
      background-color: #dbeafe;
      border-left: 3px solid #2563eb;
    }
    .session-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .conversation-item:hover .session-actions {
      opacity: 1;
    }
    @media (max-width: 768px) {
      .conversation-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
      }
      .conversation-sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      .sidebar-overlay.open {
        display: block;
      }
    }
  </style>
</head>
<body class="bg-white text-gray-800">

  <!-- Header -->
  <header class="bg-blue-900 text-white p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <div class="text-3xl font-bold">sosdivorce.fr</div>
      <nav class="hidden md:flex space-x-6">
        <a href="#about">√Ä propos</a>
        <a href="#features">Services</a>
        <a href="#pricing">Tarifs et Comment √ßa marche ?</a>
        <a href="#testimonials">T√©moignages</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact</a>
      </nav>
      <div class="flex items-center space-x-4">
        <div id="userStatus" class="hidden text-sm">
          <span id="userName"></span>
          <button onclick="logout()" class="ml-2 text-xs bg-red-600 px-2 py-1 rounded">D√©connexion</button>
        </div>
        <button id="loginBtn" onclick="showAuthModal('login')" class="bg-green-600 px-3 py-1 rounded text-sm">Connexion</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <main>
  <section class="bg-blue-50 py-16 px-4">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-stretch gap-8">
      <div class="md:w-1/2">
        <img src="logo-sosdivorce.png" alt="sosdivorce.fr - Conseil juridique divorce en ligne" class="w-full h-full min-h-80 object-cover rounded-lg shadow-lg">
      </div>
      <div class="md:w-1/2 flex flex-col justify-center text-center">
        <h1 class="text-3xl font-bold text-blue-900 mb-4">sosdivorce.fr associe IA juridique et avocats sp√©cialis√©s pour vous offrir une approche nouvelle du conseil en mati√®re de divorce.</h1>
        <p class="text-lg text-gray-600 mb-6">Notre assistant IA analyse votre situation, identifie les points cl√©s de votre dossier et pr√©pare une synth√®se pour l‚Äô√©quipe juridique.</p>
        <p class="text-lg text-gray-600 mb-6">Vous b√©n√©ficiez ensuite :</p>
        <div class="space-y-3">
          <div class="flex items-center justify-center space-x-2">
            <span>- d‚Äôune analyse personnalis√©e de votre cas,</span>
          </div>
          <div class="flex items-center justify-center space-x-2">
            <span>- d‚Äôune proposition d‚Äôhonoraires adapt√©e,</span>
          </div>
          <div class="flex items-center justify-center space-x-2">
            <span>- et d‚Äôune mise en relation directe avec un avocat partenaire exp√©riment√©.</span>
          </div>
        </div>
        <p class="text-lg text-gray-600 mb-6">üîí Service confidentiel, rapide, sans engagement.</p>
      </div>
    </div>
  </section>

  <!-- Chatbot Section with History Sidebar -->
  <section class="py-16 px-4 bg-white">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">Conseil Juridique IA Sp√©cialis√©</h2>

      <!-- Overlay for mobile sidebar -->
      <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <div class="flex gap-4 relative">
        <!-- Conversation History Sidebar (hidden by default, shown only for logged users) -->
        <div id="conversationSidebar" class="conversation-sidebar hidden bg-white border-r border-gray-200 w-64 md:w-72 p-4 overflow-y-auto" style="max-height: 600px;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-gray-800">Conversations</h3>
            <button onclick="startNewConversation()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
              + Nouvelle
            </button>
          </div>

          <!-- Stats (optional) -->
          <div id="conversationStats" class="mb-4 p-3 bg-blue-50 rounded-lg text-sm hidden">
            <div class="flex justify-between">
              <span class="text-gray-600">Total:</span>
              <span id="totalSessions" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Messages:</span>
              <span id="totalMessages" class="font-semibold">0</span>
            </div>
          </div>

          <!-- Session List -->
          <div id="sessionList" class="space-y-2">
            <div class="text-center text-gray-400 text-sm py-8">
              Aucune conversation
            </div>
          </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1">
          <div class="bg-gray-50 rounded-lg p-6 shadow-lg">
            <!-- Mobile: Button to toggle sidebar -->
            <button id="toggleSidebarBtn" onclick="toggleSidebar()" class="md:hidden mb-4 text-blue-600 hover:text-blue-700 font-medium text-sm hidden">
              ‚ò∞ Historique
            </button>

            <!-- Current Session Title (for logged users) -->
            <div id="currentSessionHeader" class="mb-4 pb-3 border-b border-gray-200 hidden">
              <h4 id="currentSessionTitle" class="font-semibold text-gray-800 text-lg">Nouvelle conversation</h4>
            </div>

            <div id="chatContainer" class="space-y-4 mb-4" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center text-gray-500">
                <p>Posez votre question juridique ci-dessous...</p>
                <p class="text-sm mt-2" id="questionCounter">Questions gratuites restantes : 2</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <input type="text" id="userInput" placeholder="Ex: Comment proc√©der pour un divorce ?" class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
              <button onclick="askGPT()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors min-w-[48px] flex-shrink-0">
                <span id="sendBtn">
                  <span class="hidden max-[500px]:inline">‚Üë</span>
                  <span class="max-[500px]:hidden">Envoyer</span>
                </span>
                <span id="loadingBtn" class="hidden">
                  <span class="hidden max-[500px]:inline">...</span>
                  <span class="max-[500px]:hidden">Envoi...</span>
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about" class="py-16 px-4 bg-gray-50">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">√Ä Propos de Notre Service</h2>
      <div class="text-center max-w-4xl mx-auto">
        <p class="text-lg text-gray-600 mb-6">
          Nous combinons la puissance de l'intelligence artificielle avec l'expertise de juristes sp√©cialis√©s pour vous accompagner sereinement √† chaque √©tape de votre divorce.
        </p>
      </div>
    </div>
  </section>

  <!-- Features Section -->
  <section id="features" class="py-16 px-4 bg-white">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">Nos Services</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="text-center p-6 bg-blue-50 rounded-lg">
          <div class="text-4xl mb-4">ü§ñ</div>
          <h3 class="text-xl font-bold text-blue-900 mb-3">IA Juridique Sp√©cialis√©e</h3>
          <p class="text-gray-600">R√©ponses instantan√©es √† vos questions sur le divorce, les proc√©dures et vos droits.</p>
        </div>
        <div class="text-center p-6 bg-green-50 rounded-lg">
          <div class="text-4xl mb-4">üë®‚Äç‚öñÔ∏è</div>
          <h3 class="text-xl font-bold text-green-900 mb-3">Avocats Qualifi√©s</h3>
          <p class="text-gray-600">Acc√®s direct √† des professionnels du droit sp√©cialis√©s en divorce √† tarif pr√©f√©rentiel.</p>
        </div>
        <div class="text-center p-6 bg-purple-50 rounded-lg">
          <div class="text-4xl mb-4">üîí</div>
          <h3 class="text-xl font-bold text-purple-900 mb-3">Confidentialit√© Totale</h3>
          <p class="text-gray-600">Vos √©changes sont s√©curis√©s et confidentiels. Nous respectons votre vie priv√©e.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Pricing Section -->
  <section id="pricing" class="py-16 px-4 bg-gray-50">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">Tarifs et Comment √ßa marche ?</h2>

      <div class="max-w-4xl mx-auto mb-12">
        <h3 class="text-2xl font-bold text-blue-900 mb-4">üí¨ Des honoraires personnalis√©s, selon votre situation</h3>
        <p class="text-lg text-gray-700 mb-4">
          Chaque dossier de divorce est unique.<br>
          Le co√ªt d√©pend notamment du type de proc√©dure (amiable ou judiciaire), de la pr√©sence d'enfants, du partage des biens, ou encore du niveau d'accord entre les √©poux.
        </p>
        <p class="text-lg text-gray-700 mb-6">
          Pour vous donner un tarif juste et transparent, nous avons mis en place un processus simple et confidentiel :
        </p>
      </div>

      <!-- Process Cards -->
      <div class="grid md:grid-cols-3 gap-8 mb-12">
        <div class="bg-white p-8 rounded-lg shadow-lg">
          <div class="text-4xl mb-4 text-center">1Ô∏è‚É£</div>
          <h3 class="text-xl font-bold text-blue-900 mb-4 text-center">Discutez avec notre assistant</h3>
          <p class="text-gray-700 text-center">
            D√©crivez votre situation directement dans le chat : type de divorce, enfants, patrimoine, objectifs (rapidit√©, co√ªt, garde, partage, etc.).
          </p>
        </div>

        <div class="bg-white p-8 rounded-lg shadow-lg">
          <div class="text-4xl mb-4 text-center">2Ô∏è‚É£</div>
          <h3 class="text-xl font-bold text-blue-900 mb-4 text-center">M√©mo automatique</h3>
          <p class="text-gray-700 text-center">
            L'assistant pr√©pare automatiquement un m√©mo r√©capitulatif de votre dossier. Ce document reprend les √©l√©ments essentiels √† l'analyse de votre cas.
          </p>
        </div>

        <div class="bg-white p-8 rounded-lg shadow-lg">
          <div class="text-4xl mb-4 text-center">3Ô∏è‚É£</div>
          <h3 class="text-xl font-bold text-blue-900 mb-4 text-center">Estimation personnalis√©e</h3>
          <p class="text-gray-700 text-center">
            Envoyez ce m√©mo √† notre √©quipe √† üìß contact@sosdivorce.fr. Nous √©tudierons votre dossier et reviendrons vers vous sous 24 √† 48 heures avec une estimation personnalis√©e des honoraires et la proposition d'un avocat partenaire sp√©cialis√©, inscrit √† un barreau fran√ßais.
          </p>
        </div>
      </div>

      <!-- Final Message -->
      <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-8 max-w-4xl mx-auto text-center">
        <p class="text-xl font-semibold text-blue-900">
          üí° Cet accompagnement est enti√®rement gratuit et sans engagement.
        </p>
        <p class="text-lg text-gray-700 mt-3">
          Vous restez libre d'accepter ou non la mise en relation.
        </p>
      </div>
    </div>
  </section>

  <!-- Testimonials Section -->
  <section id="testimonials" class="py-16 px-4 bg-white">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">T√©moignages</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"Service exceptionnel ! J'ai eu des r√©ponses claires et pr√©cises √† toutes mes questions sur mon divorce."</p>
          <div class="font-bold text-blue-900">Marie L.</div>
        </div>
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"L'IA r√©pond instantan√©ment et l'acc√®s √† l'avocat m'a fait gagner beaucoup de temps."</p>
          <div class="font-bold text-blue-900">Pierre M.</div>
        </div>
        <div class="bg-gray-50 p-6 rounded-lg">
          <div class="text-yellow-400 mb-4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="text-gray-600 mb-4">"Parfait pour comprendre les d√©marches de divorce. Service confidentiel et efficace."</p>
          <div class="font-bold text-blue-900">Sophie D.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section id="faq" class="py-16 px-4 bg-gray-50">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold text-center text-blue-900 mb-12">Questions Fr√©quentes</h2>
      <div class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Comment fonctionne l'IA juridique ?</h3>
          <p class="text-gray-600">Notre IA est sp√©cialement entra√Æn√©e sur le droit fran√ßais du divorce. Elle peut vous donner des informations g√©n√©rales et vous orienter vers les bonnes proc√©dures.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Les informations sont-elles confidentielles ?</h3>
          <p class="text-gray-600">Absolument. Tous vos √©changes sont chiffr√©s et confidentiels. Nous ne partageons aucune information personnelle.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-bold text-blue-900 mb-3">Puis-je vraiment parler √† un avocat ?</h3>
          <p class="text-gray-600">Oui, nos abonn√©s ont acc√®s √† des consultations avec des avocats sp√©cialis√©s en divorce √† tarif pr√©f√©rentiel.</p>
      </div>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section id="contact" class="py-16 px-4 bg-blue-900 text-white">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-3xl font-bold mb-8">Contactez-Nous</h2>
      <p class="text-xl mb-8">Une question ? Besoin d'aide ? Notre √©quipe est l√† pour vous.</p>
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4">Informations</h3>
          <p class="mb-2">üìß contact@sosdivorce.fr</p>
          <p>üïí Lun-Ven 9h-18h</p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Support</h3>
          <p class="mb-2">üí¨ Chat en ligne</p>
          <p class="mb-2">üìß support@sosdivorce.fr</p>
          <p>üì± R√©ponse sous 24h</p>
        </div>
      </div>
    </div>
  </section>
  </main>

  <!-- Modal d'authentification -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex justify-center min-h-screen p-4 py-8">
      <div class="bg-white rounded-lg max-w-md w-full my-auto flex flex-col" style="max-height: calc(100vh - 4rem);">
        <div class="p-8 pb-0">
          <div class="flex justify-between items-center mb-6">
            <h2 id="authTitle" class="text-2xl font-bold text-blue-900">Connexion</h2>
            <button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>

          <!-- Onglets -->
          <div class="flex mb-6 border-b">
            <button onclick="showAuthModal('login')" id="loginTab" class="flex-1 py-2 px-4 text-center border-b-2 border-blue-600 text-blue-600 font-medium">Connexion</button>
            <button onclick="showAuthModal('register')" id="registerTab" class="flex-1 py-2 px-4 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">Inscription</button>
          </div>

          <!-- Message d'erreur/succ√®s -->
          <div id="authMessage" class="hidden mb-4 p-3 rounded"></div>
        </div>

        <div class="px-8 pb-8 overflow-y-auto">
        <!-- Formulaire de connexion -->
        <form id="loginForm" onsubmit="submitLogin(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input type="email" name="email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
            <input type="password" name="password" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <button type="submit" id="loginSubmitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
            Se connecter
          </button>
        </form>

        <!-- Formulaire d'inscription -->
        <form id="registerForm" onsubmit="submitRegister(event)" class="hidden space-y-4">
          <!-- Avantages de l'inscription -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Avantages de l'inscription
            </h3>
            <ul class="text-sm text-blue-800 space-y-1">
              <li class="flex items-start">
                <span class="text-blue-600 mr-2">‚úì</span>
                <span><strong>Questions illimit√©es</strong> - Posez autant de questions que vous le souhaitez</span>
              </li>
              <li class="flex items-start">
                <span class="text-blue-600 mr-2">‚úì</span>
                <span><strong>Historique sauvegard√©</strong> - Retrouvez toutes vos conversations</span>
              </li>
            </ul>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pr√©nom</label>
            <input type="text" name="firstName" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
            <input type="text" name="lastName" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input type="email" name="email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
            <input type="password" name="password" required minlength="6" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">Minimum 6 caract√®res</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Confirmer le mot de passe</label>
            <input type="password" name="confirmPassword" required minlength="6" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <button type="submit" id="registerSubmitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
            S'inscrire
          </button>
          <p class="text-xs text-gray-500 text-center">
            En vous inscrivant, vous acceptez nos conditions d'utilisation et notre politique de confidentialit√©.
          </p>
        </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 px-4">
    <div class="max-w-6xl mx-auto text-center">
      <div class="text-2xl font-bold mb-4">sosdivorce.fr</div>
      <p class="text-gray-400 mb-4">Conseil juridique divorce en ligne avec IA et avocat sp√©cialis√©</p>
      <div class="mt-6 text-sm text-gray-400">
        <p>&copy; 2024 sosdivorce.fr - Tous droits r√©serv√©s</p>
      </div>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let questionsUsed = 0;
    const maxFreeQuestions = 2;
    let currentSessionId = null; // ID de la session de conversation actuelle
    let conversationSessions = []; // Liste des sessions

    // V√©rifier le statut utilisateur au chargement
    document.addEventListener('DOMContentLoaded', function() {
      checkUserStatus();
      updateQuestionCounter();
    });

    // V√©rifier le statut de l'utilisateur
    async function checkUserStatus() {
      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'check' })
        });

        const data = await response.json();
        
        if (data.success && data.user) {
          currentUser = data.user;
          showUserStatus(data.user);
        } else {
          hideUserStatus();
        }
      } catch (error) {
        console.error('Erreur v√©rification statut:', error);
        hideUserStatus();
      }
    }

    // Afficher le statut utilisateur
    function showUserStatus(user) {
      document.getElementById('userStatus').classList.remove('hidden');
      document.getElementById('loginBtn').classList.add('hidden');
      document.getElementById('userName').textContent = user.firstName || user.email;

      // Masquer le compteur de questions gratuites
      updateQuestionCounter();

      // Afficher la sidebar et charger l'historique
      showConversationSidebar();
      loadConversationHistory();
    }

    // Masquer le statut utilisateur
    function hideUserStatus() {
      document.getElementById('userStatus').classList.add('hidden');
      document.getElementById('loginBtn').classList.remove('hidden');

      // Masquer la sidebar
      hideConversationSidebar();
    }

    // Lire les cookies (helper function)
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    // Mettre √† jour le compteur de questions
    function updateQuestionCounter() {
      const counterElement = document.getElementById('questionCounter');

      // Si l'utilisateur est connect√©, masquer le compteur
      if (currentUser) {
        if (counterElement) {
          counterElement.style.display = 'none';
        }
        return;
      }

      // Sinon, afficher et mettre √† jour le compteur
      if (counterElement) {
        counterElement.style.display = 'block';

        // Lire le cookie q_used pour synchroniser avec le serveur
        const qUsedCookie = getCookie('q_used');
        if (qUsedCookie) {
          questionsUsed = parseInt(qUsedCookie) || 0;
        }

        const remaining = maxFreeQuestions - questionsUsed;
        counterElement.textContent = `Questions gratuites restantes : ${remaining}`;
      }
    }

    // Afficher le modal d'authentification
    function showAuthModal(type) {
      const modal = document.getElementById('authModal');
      const title = document.getElementById('authTitle');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const loginTab = document.getElementById('loginTab');
      const registerTab = document.getElementById('registerTab');
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('authMessage').classList.add('hidden');
      
      if (type === 'login') {
        title.textContent = 'Connexion';
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        loginTab.classList.add('border-blue-600', 'text-blue-600');
        loginTab.classList.remove('border-transparent', 'text-gray-500');
        registerTab.classList.remove('border-blue-600', 'text-blue-600');
        registerTab.classList.add('border-transparent', 'text-gray-500');
      } else {
        title.textContent = 'Inscription';
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
        registerTab.classList.add('border-blue-600', 'text-blue-600');
        registerTab.classList.remove('border-transparent', 'text-gray-500');
        loginTab.classList.remove('border-blue-600', 'text-blue-600');
        loginTab.classList.add('border-transparent', 'text-gray-500');
      }
    }

    // Fermer le modal d'authentification
    function closeAuthModal() {
      document.getElementById('authModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('authMessage').classList.add('hidden');
    }

    // Soumettre la connexion
    async function submitLogin(event) {
      event.preventDefault();
      
      const form = event.target;
      const submitBtn = document.getElementById('loginSubmitBtn');
      
      const formData = {
        action: 'login',
        email: form.email.value.trim(),
        password: form.password.value
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Connexion...';

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showMessage('Connexion r√©ussie !', 'success');
          currentUser = data.user;

          // Sauvegarder les messages anonymes s'il y en a
          await saveAnonymousMessages();

          showUserStatus(data.user);
          setTimeout(() => {
            closeAuthModal();
            form.reset();
          }, 1500);
        } else {
          throw new Error(data.error || data.message);
        }

      } catch (error) {
        showMessage(error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Se connecter';
      }
    }

    // Soumettre l'inscription
    async function submitRegister(event) {
      event.preventDefault();

      const form = event.target;
      const submitBtn = document.getElementById('registerSubmitBtn');

      // V√©rifier que les mots de passe correspondent
      const password = form.password.value;
      const confirmPassword = form.confirmPassword.value;

      if (password !== confirmPassword) {
        showMessage('Les mots de passe ne correspondent pas', 'error');
        return;
      }

      const formData = {
        action: 'register',
        firstName: form.firstName.value.trim(),
        lastName: form.lastName.value.trim(),
        email: form.email.value.trim(),
        password: password
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Inscription en cours...';

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showMessage('Inscription r√©ussie ! Vous pouvez maintenant poser des questions illimit√©es.', 'success');
          currentUser = data.user;

          // Sauvegarder les messages anonymes s'il y en a
          await saveAnonymousMessages();

          showUserStatus(data.user);

          setTimeout(() => {
            closeAuthModal();
            form.reset();
          }, 2000);
        } else {
          throw new Error(data.error || 'Erreur lors de l\'inscription');
        }

      } catch (error) {
        showMessage(error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'S\'inscrire';
      }
    }

    // D√©connexion
    async function logout() {
      try {
        await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'logout' })
        });

        currentUser = null;
        currentSessionId = null;
        conversationSessions = [];

        // Vider la chatbox
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = `
          <div class="text-center text-gray-500">
            <p>Posez votre question juridique ci-dessous...</p>
            <p class="text-sm mt-2" id="questionCounter">Questions gratuites restantes : 2</p>
          </div>
        `;

        // R√©initialiser le compteur de questions
        questionsUsed = 0;
        updateQuestionCounter();

        hideUserStatus();
        showMessage('D√©connexion r√©ussie', 'success');
      } catch (error) {
        console.error('Erreur de d√©connexion:', error);
      }
    }

    // Afficher un message
    function showMessage(message, type) {
      const messageDiv = document.getElementById('authMessage');
      messageDiv.textContent = message;
      messageDiv.className = `p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
      messageDiv.classList.remove('hidden');
    }

    // Sauvegarder les messages anonymes apr√®s connexion/inscription
    async function saveAnonymousMessages() {
      const chatContainer = document.getElementById('chatContainer');
      const messageElements = chatContainer.querySelectorAll('.flex');

      if (messageElements.length === 0) {
        return; // Pas de messages √† sauvegarder
      }

      // Collecter les messages de la chatbox
      const messages = [];
      messageElements.forEach(msgDiv => {
        const isUser = msgDiv.classList.contains('justify-end');
        const messageContent = msgDiv.querySelector('div');

        if (messageContent) {
          // Extraire le texte en ignorant les badges "Cache" et autres √©l√©ments
          let text = '';
          messageContent.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) {
              text += node.textContent;
            } else if (node.nodeName === 'SPAN' && !node.classList.contains('typing-cursor') && !node.textContent.includes('Cache')) {
              text += node.textContent;
            }
          });

          text = text.trim();
          if (text && !text.includes('R√©flexion en cours') && !text.includes('Posez votre question')) {
            messages.push({
              role: isUser ? 'user' : 'assistant',
              content: text
            });
          }
        }
      });

      if (messages.length === 0) {
        return; // Pas de vrais messages √† sauvegarder
      }

      try {
        // Envoyer les messages au serveur pour les sauvegarder
        const response = await fetch('/api/conversations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            action: 'saveAnonymous',
            messages: messages
          })
        });

        const data = await response.json();

        if (data.success && data.sessionId) {
          currentSessionId = data.sessionId;
          // Recharger l'historique pour afficher la nouvelle session
          await loadConversationHistory();
        }
      } catch (error) {
        console.error('Erreur sauvegarde messages anonymes:', error);
      }
    }

    // Fonction principale pour poser une question
    async function askGPT() {
      const userInput = document.getElementById('userInput');
      const question = userInput.value.trim();
      
      if (!question) {
        alert('Veuillez saisir une question.');
        return;
      }

      // V√©rifier si l'utilisateur peut poser une question
      if (!currentUser && questionsUsed >= maxFreeQuestions) {
        showAuthModal('register');
        return;
      }

      // Afficher la question de l'utilisateur
      addMessage(question, 'user');
      userInput.value = '';

      // Afficher l'indicateur de chargement
      const loadingId = addMessage('R√©flexion en cours...', 'assistant', true);
      
      // D√©sactiver le bouton
      const sendBtn = document.getElementById('sendBtn');
      const loadingBtn = document.getElementById('loadingBtn');
      sendBtn.classList.add('hidden');
      loadingBtn.classList.remove('hidden');

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            message: question,
            sessionId: currentSessionId // Envoyer l'ID de session actuel
          })
        });

        // V√©rifier si la r√©ponse est OK avant de parser le JSON
        if (!response.ok) {
          let errorMessage = 'Erreur serveur';
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            // Si le JSON parsing √©choue, utiliser le message par d√©faut
            errorMessage = `Erreur ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        // Supprimer le message de chargement
        removeMessage(loadingId);

        if (data.success) {
          // Ajouter la r√©ponse avec effet de frappe
          addTypingMessage(data.response);

          // Mettre √† jour le sessionId si nouvelle session cr√©√©e
          if (data.sessionId) {
            currentSessionId = data.sessionId;

            // Si utilisateur connect√©, mettre √† jour le titre et recharger l'historique
            if (currentUser) {
              // Mettre le titre de la session (premi√®re question)
              if (!document.getElementById('currentSessionTitle').textContent.includes(question.substring(0, 30))) {
                document.getElementById('currentSessionTitle').textContent = question.substring(0, 50) + (question.length > 50 ? '...' : '');
              }

              // Recharger l'historique pour afficher la nouvelle session
              setTimeout(() => {
                loadConversationHistory();
              }, 500);
            }
          }

          // Incr√©menter le compteur si utilisateur non connect√©
          if (!currentUser) {
            questionsUsed++;
            updateQuestionCounter();
          }
        } else if (data.needSignup) {
          // L'utilisateur a atteint la limite de 2 questions
          addMessage(data.message, 'assistant');

          // Mettre √† jour le compteur pour refl√©ter les 2 questions utilis√©es
          if (!currentUser) {
            questionsUsed = data.qUsed || 2;
            updateQuestionCounter();
          }

          // Afficher le modal d'inscription apr√®s un court d√©lai
          setTimeout(() => {
            showAuthModal('register');
          }, 500);
        } else {
          throw new Error(data.error || 'Erreur lors de la g√©n√©ration de la r√©ponse');
        }

      } catch (error) {
        removeMessage(loadingId);
        addMessage('Erreur: ' + error.message + '. Veuillez r√©essayer.', 'assistant');
      } finally {
        // R√©activer le bouton
        sendBtn.classList.remove('hidden');
        loadingBtn.classList.add('hidden');
      }
    }

    // Ajouter un message au chat
    function addMessage(message, sender, isLoading = false) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      const messageId = 'msg_' + Date.now();
      
      messageDiv.id = messageId;
      messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
      
      const messageContent = document.createElement('div');
      messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
        sender === 'user' 
          ? 'bg-blue-600 text-white' 
          : 'bg-gray-200 text-gray-800'
      }`;
      
      if (isLoading) {
        // Cr√©er le contenu de mani√®re s√ªre sans innerHTML
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        const cursorSpan = document.createElement('span');
        cursorSpan.className = 'typing-cursor';
        messageContent.appendChild(textSpan);
        messageContent.appendChild(cursorSpan);
      } else {
        messageContent.textContent = message;
      }
      
      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);
      
      // Scroll vers le bas
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      return messageId;
    }

    // Supprimer un message
    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // Ajouter un message avec effet de frappe
    function addTypingMessage(text) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');

      messageDiv.className = 'flex justify-start';

      const messageContent = document.createElement('div');
      messageContent.className = 'max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-200 text-gray-800';

      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);

      // Cr√©er les √©l√©ments pour l'effet de frappe de mani√®re s√ªre
      const textSpan = document.createElement('span');
      const cursorSpan = document.createElement('span');
      cursorSpan.className = 'typing-cursor';
      cursorSpan.textContent = '|';

      messageContent.appendChild(textSpan);
      messageContent.appendChild(cursorSpan);

      // Effet de frappe
      let i = 0;
      const typingInterval = setInterval(() => {
        if (i < text.length) {
          textSpan.textContent = text.substring(0, i + 1);
          i++;
        } else {
          textSpan.textContent = text;
          cursorSpan.remove();
          clearInterval(typingInterval);
        }
        
        // Scroll vers le bas
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 30);
    }

    // Permettre d'envoyer avec Entr√©e
    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        askGPT();
      }
    });

    // ====================================
    // GESTION DE L'HISTORIQUE DES CONVERSATIONS
    // ====================================

    // Afficher la sidebar des conversations
    function showConversationSidebar() {
      document.getElementById('conversationSidebar').classList.remove('hidden');
      document.getElementById('toggleSidebarBtn').classList.remove('hidden');
      document.getElementById('currentSessionHeader').classList.remove('hidden');
    }

    // Masquer la sidebar des conversations
    function hideConversationSidebar() {
      document.getElementById('conversationSidebar').classList.add('hidden');
      document.getElementById('toggleSidebarBtn').classList.add('hidden');
      document.getElementById('currentSessionHeader').classList.add('hidden');
    }

    // Toggle sidebar sur mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('conversationSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    // Charger l'historique des conversations
    async function loadConversationHistory() {
      try {
        const response = await fetch('/api/conversations', {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          conversationSessions = data.sessions || [];
          renderSessionList();

          // Charger les stats (optionnel)
          loadConversationStats();
        }
      } catch (error) {
        console.error('Erreur chargement historique:', error);
      }
    }

    // Charger les statistiques
    async function loadConversationStats() {
      try {
        const response = await fetch('/api/conversations?action=stats', {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success && data.stats) {
          document.getElementById('conversationStats').classList.remove('hidden');
          document.getElementById('totalSessions').textContent = data.stats.totalSessions;
          document.getElementById('totalMessages').textContent = data.stats.totalMessages;
        }
      } catch (error) {
        console.error('Erreur chargement stats:', error);
      }
    }

    // Afficher la liste des sessions
    function renderSessionList() {
      const sessionList = document.getElementById('sessionList');

      if (conversationSessions.length === 0) {
        sessionList.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">Aucune conversation</div>';
        return;
      }

      sessionList.innerHTML = conversationSessions.map(session => `
        <div class="conversation-item p-3 rounded-lg cursor-pointer ${session.id === currentSessionId ? 'active' : ''}"
             onclick="loadSession(${session.id})">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <h4 class="font-medium text-sm text-gray-800 truncate">${escapeHtml(session.title)}</h4>
              <p class="text-xs text-gray-500 mt-1">${session.messageCount} messages</p>
              <p class="text-xs text-gray-400">${formatDate(session.lastMessageAt)}</p>
            </div>
            <div class="session-actions ml-2 flex space-x-1">
              <button onclick="event.stopPropagation(); deleteSession(${session.id})"
                      class="text-red-500 hover:text-red-700 p-1"
                      title="Supprimer">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Charger une session sp√©cifique
    async function loadSession(sessionId) {
      try {
        // Fermer sidebar sur mobile
        document.getElementById('conversationSidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');

        const response = await fetch(`/api/conversations?sessionId=${sessionId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          currentSessionId = sessionId;

          // Mettre √† jour le titre
          const session = conversationSessions.find(s => s.id === sessionId);
          if (session) {
            document.getElementById('currentSessionTitle').textContent = session.title;
          }

          // Afficher les messages
          const chatContainer = document.getElementById('chatContainer');
          chatContainer.innerHTML = '';

          data.messages.forEach(msg => {
            addMessageToUI(msg.content, msg.role, false, msg.wasCached);
          });

          // Mettre √† jour l'affichage de la session active
          renderSessionList();
        }
      } catch (error) {
        console.error('Erreur chargement session:', error);
      }
    }

    // D√©marrer une nouvelle conversation
    function startNewConversation() {
      currentSessionId = null;
      document.getElementById('currentSessionTitle').textContent = 'Nouvelle conversation';
      document.getElementById('chatContainer').innerHTML = `
        <div class="text-center text-gray-500">
          <p>Posez votre question juridique ci-dessous...</p>
        </div>
      `;
      renderSessionList();

      // Fermer sidebar sur mobile
      document.getElementById('conversationSidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('open');
    }

    // Supprimer une session
    async function deleteSession(sessionId) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette conversation ?')) {
        return;
      }

      try {
        const response = await fetch(`/api/conversations?sessionId=${sessionId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          // Si c'√©tait la session active, d√©marrer une nouvelle
          if (sessionId === currentSessionId) {
            startNewConversation();
          }

          // Recharger l'historique
          await loadConversationHistory();
        } else {
          alert('Erreur lors de la suppression');
        }
      } catch (error) {
        console.error('Erreur suppression session:', error);
        alert('Erreur lors de la suppression');
      }
    }

    // Ajouter un message √† l'interface (helper am√©lior√©)
    function addMessageToUI(message, sender, isLoading = false, isCached = false) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      const messageId = 'msg_' + Date.now();

      messageDiv.id = messageId;
      messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

      const messageContent = document.createElement('div');
      messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
        sender === 'user'
          ? 'bg-blue-600 text-white'
          : 'bg-gray-200 text-gray-800'
      }`;

      if (isLoading) {
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        const cursorSpan = document.createElement('span');
        cursorSpan.className = 'typing-cursor';
        messageContent.appendChild(textSpan);
        messageContent.appendChild(cursorSpan);
      } else {
        messageContent.textContent = message;

        // Badge "Cached" si applicable
        if (isCached && sender === 'assistant') {
          const badge = document.createElement('span');
          badge.className = 'ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded';
          badge.textContent = 'Cache';
          messageContent.appendChild(badge);
        }
      }

      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return messageId;
    }

    // Utilitaires
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return '√Ä l\'instant';
      if (diffMins < 60) return `Il y a ${diffMins}min`;
      if (diffHours < 24) return `Il y a ${diffHours}h`;
      if (diffDays === 1) return 'Hier';
      if (diffDays < 7) return `Il y a ${diffDays}j`;

      return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    }
  </script>

</body>
</html>