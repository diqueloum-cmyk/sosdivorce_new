<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - sos-impots.ai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'system-ui', sans-serif; }
    .tab-button.active {
      color: #1e3a8a;
      border-bottom-color: #1e3a8a;
    }
    .tab-content.hidden {
      display: none;
    }
    .sub-tab-button.active {
      background-color: #2563eb;
      color: white;
    }
    .view-content.hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Modal de connexion admin -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-blue-900 mb-6">Authentification Admin</h2>
      <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Clé Admin</label>
          <input
            type="password"
            id="adminKeyInput"
            required
            placeholder="Entrez votre clé admin"
            class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
          Se connecter
        </button>
      </form>
    </div>
  </div>

  <!-- Contenu admin (caché par défaut) -->
  <div id="adminContent" class="hidden">
    <div class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-blue-900">Administration - sos-impots.ai</h1>
          <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            Déconnexion
          </button>
        </div>

        <!-- Onglets -->
        <div class="mb-8">
          <div class="flex border-b border-gray-300">
            <button id="tabStats" class="tab-button active px-6 py-3 font-semibold text-blue-900 border-b-2 border-blue-900">
              Statistiques
            </button>
            <button id="tabConversations" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-900">
              Conversations
            </button>
          </div>
        </div>

        <!-- Contenu Onglet Statistiques -->
        <div id="contentStats" class="tab-content">

      <!-- Statistiques -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold text-blue-900">Total Utilisateurs</h3>
          <p id="totalUsers" class="text-2xl font-bold text-blue-600">-</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold text-green-900">Inscriptions Aujourd'hui</h3>
          <p id="todayUsers" class="text-2xl font-bold text-green-600">-</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold text-purple-900">Dernier Utilisateur</h3>
          <p id="lastUser" class="text-sm text-purple-600">-</p>
        </div>
      </div>

      <!-- Bouton de rafraîchissement -->
      <div class="mb-6">
        <button onclick="loadStats()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Actualiser les données
        </button>
        <button onclick="loadUsers()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 ml-2">
          Voir tous les utilisateurs
        </button>
      </div>

      <!-- Liste des utilisateurs -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Utilisateurs Inscrits</h2>
        <div id="usersList" class="space-y-2">
          <p class="text-gray-500">Cliquez sur "Voir tous les utilisateurs" pour charger la liste</p>
        </div>
      </div>

      <!-- Messages d'erreur -->
      <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>

        </div>
        <!-- Fin Contenu Onglet Statistiques -->

        <!-- Contenu Onglet Conversations -->
        <div id="contentConversations" class="tab-content hidden">
          <!-- Sous-onglets -->
          <div class="mb-6">
            <div class="flex gap-4 mb-4">
              <button id="viewByUser" class="sub-tab-button active px-4 py-2 bg-blue-600 text-white rounded">
                Par utilisateur
              </button>
              <button id="viewAll" class="sub-tab-button px-4 py-2 bg-gray-300 text-gray-700 rounded">
                Toutes les conversations
              </button>
              <button id="viewAnonymous" class="sub-tab-button px-4 py-2 bg-gray-300 text-gray-700 rounded">
                Utilisateurs anonymes
                <span id="anonymousCount" class="ml-2 bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">0</span>
              </button>
            </div>

            <!-- Filtres -->
            <div class="flex gap-4 mb-6">
              <select id="dateFilter" class="border rounded px-4 py-2">
                <option value="">Toutes les dates</option>
                <option value="7d">7 derniers jours</option>
                <option value="30d">30 derniers jours</option>
              </select>

              <select id="userFilter" class="border rounded px-4 py-2">
                <option value="">Tous les utilisateurs</option>
              </select>

              <button onclick="exportConversations()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Exporter CSV
              </button>
            </div>
          </div>

          <!-- Vue Par Utilisateur -->
          <div id="viewUserContent" class="view-content">
            <div id="userConvList" class="grid grid-cols-1 gap-4">
              <!-- Liste des utilisateurs avec nombre de conversations -->
            </div>
          </div>

          <!-- Vue Toutes les Conversations -->
          <div id="viewAllContent" class="view-content hidden">
            <div id="conversationsList" class="space-y-4">
              <!-- Liste des conversations -->
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center gap-2 mt-6">
              <!-- Boutons de pagination -->
            </div>
          </div>

          <!-- Vue Conversations Anonymes -->
          <div id="viewAnonymousContent" class="view-content hidden">
            <div class="bg-white rounded-lg shadow">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Identifiant</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Navigateur</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Titre</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Messages</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="anonymousConversationsList" class="bg-white divide-y divide-gray-200">
                  <!-- Rempli dynamiquement -->
                </tbody>
              </table>
            </div>

            <!-- Pagination anonymes -->
            <div id="anonymousPagination" class="flex justify-center gap-2 mt-6">
              <!-- Boutons de pagination -->
            </div>
          </div>

          <!-- Modal Détail Conversation -->
          <div id="conversationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="flex justify-center min-h-screen p-4">
              <div class="bg-white rounded-lg max-w-4xl w-full my-auto p-8">
                <div class="flex justify-between items-center mb-6">
                  <h2 id="modalTitle" class="text-2xl font-bold text-blue-900"></h2>
                  <button onclick="closeConversationModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <div id="modalContent" class="space-y-4 max-h-96 overflow-y-auto">
                  <!-- Messages Q&A -->
                </div>

                <div class="mt-6 flex gap-4">
                  <button onclick="deleteConversation()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    Supprimer
                  </button>
                  <button onclick="closeConversationModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                    Fermer
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- Fin Contenu Onglet Conversations -->

      </div>
    </div>
  </div>

  <script>
    let adminKey = null;

    // Vérifier si déjà connecté au chargement
    document.addEventListener('DOMContentLoaded', function() {
      const savedKey = sessionStorage.getItem('adminKey');
      if (savedKey) {
        // Vérifier si la clé est toujours valide
        adminKey = savedKey;
        testAdminKey(savedKey);
      }
    });

    async function handleLogin(event) {
      event.preventDefault();
      const testKey = document.getElementById('adminKeyInput').value;

      try {
        // Tester la clé admin en appelant les stats
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': testKey
          },
          body: JSON.stringify({ action: 'stats', adminKey: testKey })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          adminKey = testKey;
          sessionStorage.setItem('adminKey', testKey);
          showAdminContent();
          loadStats();
        } else {
          throw new Error('Clé admin invalide');
        }
      } catch (error) {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = 'Clé admin invalide. Veuillez réessayer.';
        errorDiv.classList.remove('hidden');
      }
    }

    async function testAdminKey(key) {
      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': key
          },
          body: JSON.stringify({ action: 'stats', adminKey: key })
        });

        if (response.ok) {
          showAdminContent();
          loadStats();
        } else {
          // Clé invalide, afficher le modal
          sessionStorage.removeItem('adminKey');
          adminKey = null;
        }
      } catch (error) {
        sessionStorage.removeItem('adminKey');
        adminKey = null;
      }
    }

    function showAdminContent() {
      document.getElementById('authModal').classList.add('hidden');
      document.getElementById('adminContent').classList.remove('hidden');
    }

    function logout() {
      adminKey = null;
      sessionStorage.removeItem('adminKey');
      document.getElementById('authModal').classList.remove('hidden');
      document.getElementById('adminContent').classList.add('hidden');
      document.getElementById('adminKeyInput').value = '';
    }

    async function loadStats() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'stats', adminKey: adminKey })
        });

        const data = await response.json();

        if (response.status === 403) {
          // Session expirée, demander reconnexion
          logout();
          throw new Error('Session expirée. Veuillez vous reconnecter.');
        }

        if (data.success) {
          document.getElementById('totalUsers').textContent = data.stats.totalUsers;
          document.getElementById('todayUsers').textContent = data.stats.todayUsers;

          if (data.stats.lastUser) {
            document.getElementById('lastUser').textContent =
              `${data.stats.lastUser.firstName} ${data.stats.lastUser.lastName} (${data.stats.lastUser.email})`;
          } else {
            document.getElementById('lastUser').textContent = 'Aucun utilisateur';
          }
        } else {
          throw new Error(data.error || 'Erreur lors du chargement des statistiques');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    async function loadUsers() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'list', adminKey: adminKey })
        });

        const data = await response.json();

        if (response.status === 403) {
          // Session expirée, demander reconnexion
          logout();
          throw new Error('Session expirée. Veuillez vous reconnecter.');
        }

        if (data.success) {
          displayUsers(data.users);
        } else {
          throw new Error(data.error || 'Erreur lors du chargement des utilisateurs');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    function displayUsers(users) {
      const usersList = document.getElementById('usersList');

      // Vider la liste
      usersList.innerHTML = '';

      if (users.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'text-gray-500';
        emptyMsg.textContent = 'Aucun utilisateur inscrit';
        usersList.appendChild(emptyMsg);
        return;
      }

      // Créer les éléments DOM de manière sûre (sans innerHTML)
      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'bg-gray-50 p-4 rounded-lg border';

        const flexDiv = document.createElement('div');
        flexDiv.className = 'flex justify-between items-start';

        const infoDiv = document.createElement('div');

        const nameH4 = document.createElement('h4');
        nameH4.className = 'font-semibold text-gray-800';
        nameH4.textContent = `${user.firstName} ${user.lastName}`;

        const emailP = document.createElement('p');
        emailP.className = 'text-gray-600';
        emailP.textContent = user.email;

        const dateP = document.createElement('p');
        dateP.className = 'text-sm text-gray-500';
        dateP.textContent = `Inscrit le: ${new Date(user.registeredAt).toLocaleDateString('fr-FR')}`;

        const idDiv = document.createElement('div');
        idDiv.className = 'text-sm text-gray-500';
        idDiv.textContent = `ID: ${user.id}`;

        infoDiv.appendChild(nameH4);
        infoDiv.appendChild(emailP);
        infoDiv.appendChild(dateP);

        flexDiv.appendChild(infoDiv);
        flexDiv.appendChild(idDiv);

        userDiv.appendChild(flexDiv);
        usersList.appendChild(userDiv);
      });
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');

      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }

    // ========================================
    // GESTION DES CONVERSATIONS
    // ========================================

    let currentPage = 1;
    let currentDateFilter = '';
    let currentUserFilter = '';
    let currentSessionId = null;

    // Gestion des onglets principaux
    document.getElementById('tabStats').addEventListener('click', () => {
      switchTab('Stats');
    });

    document.getElementById('tabConversations').addEventListener('click', () => {
      switchTab('Conversations');
      loadConversations();
    });

    function switchTab(tab) {
      // Désactiver tous les onglets
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-b-2', 'border-blue-900', 'text-blue-900');
        btn.classList.add('text-gray-600');
      });
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

      // Activer l'onglet sélectionné
      const activeTab = document.getElementById(`tab${tab}`);
      activeTab.classList.add('active', 'border-b-2', 'border-blue-900', 'text-blue-900');
      activeTab.classList.remove('text-gray-600');
      document.getElementById(`content${tab}`).classList.remove('hidden');
    }

    // Gestion des sous-onglets
    document.getElementById('viewByUser').addEventListener('click', () => {
      switchView('User');
      loadUserConversations();
    });

    document.getElementById('viewAll').addEventListener('click', () => {
      switchView('All');
      loadAllConversations();
    });

    document.getElementById('viewAnonymous').addEventListener('click', () => {
      switchView('Anonymous');
      loadAnonymousConversations(1);
    });

    function switchView(view) {
      document.querySelectorAll('.sub-tab-button').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700');
      });
      document.querySelectorAll('.view-content').forEach(content => content.classList.add('hidden'));

      if (view === 'User') {
        const btn = document.getElementById('viewByUser');
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        document.getElementById('viewUserContent').classList.remove('hidden');
      } else if (view === 'All') {
        const btn = document.getElementById('viewAll');
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        document.getElementById('viewAllContent').classList.remove('hidden');
      } else if (view === 'Anonymous') {
        const btn = document.getElementById('viewAnonymous');
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        document.getElementById('viewAnonymousContent').classList.remove('hidden');
      }
    }

    // Charger les conversations
    async function loadConversations() {
      switchView('User');  // Afficher la vue "Par utilisateur" par défaut
      await loadUserFilter();
      await loadUserConversations();
    }

    async function loadUserFilter() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'list', adminKey })
        });

        const data = await response.json();
        const select = document.getElementById('userFilter');
        select.innerHTML = '<option value="">Tous les utilisateurs</option>';

        if (data.users) {
          data.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        showError('Erreur lors du chargement des utilisateurs: ' + error.message);
      }
    }

    async function loadUserConversations() {
      if (!adminKey) return;

      try {
        // Récupérer tous les utilisateurs
        const usersResponse = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'list', adminKey })
        });
        const usersData = await usersResponse.json();

        const userList = document.getElementById('userConvList');
        userList.innerHTML = '';

        if (!usersData.users || usersData.users.length === 0) {
          userList.innerHTML = '<p class="text-gray-500">Aucun utilisateur inscrit</p>';
          return;
        }

        // Pour chaque utilisateur, récupérer le nombre de conversations
        for (const user of usersData.users) {
          const response = await fetch(`/api/admin-conversations?action=list&userId=${user.id}&limit=999`, {
            headers: { 'X-Admin-Key': adminKey }
          });
          const data = await response.json();

          const userCard = document.createElement('div');
          userCard.className = 'bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-lg transition';
          userCard.onclick = () => showUserConversations(user.id);

          const nameH3 = document.createElement('h3');
          nameH3.className = 'font-bold text-lg';
          nameH3.textContent = `${user.firstName} ${user.lastName}`;

          const emailP = document.createElement('p');
          emailP.className = 'text-gray-600';
          emailP.textContent = user.email;

          const convP = document.createElement('p');
          convP.className = 'text-blue-600 mt-2';
          convP.textContent = `${data.total || 0} conversation(s)`;

          userCard.appendChild(nameH3);
          userCard.appendChild(emailP);
          userCard.appendChild(convP);
          userList.appendChild(userCard);
        }
      } catch (error) {
        showError('Erreur lors du chargement des conversations: ' + error.message);
      }
    }

    function showUserConversations(userId) {
      currentUserFilter = userId;
      document.getElementById('userFilter').value = userId;
      switchView('All');
      loadAllConversations();
    }

    async function loadAllConversations() {
      if (!adminKey) return;

      currentDateFilter = document.getElementById('dateFilter').value;
      currentUserFilter = document.getElementById('userFilter').value;

      let url = `/api/admin-conversations?action=list&page=${currentPage}&limit=50`;
      if (currentDateFilter) url += `&dateFilter=${currentDateFilter}`;
      if (currentUserFilter) url += `&userId=${currentUserFilter}`;

      try {
        const response = await fetch(url, {
          headers: { 'X-Admin-Key': adminKey }
        });
        const data = await response.json();

        const list = document.getElementById('conversationsList');
        list.innerHTML = '';

        if (!data.sessions || data.sessions.length === 0) {
          list.innerHTML = '<p class="text-gray-500">Aucune conversation trouvée</p>';
          return;
        }

        data.sessions.forEach(session => {
          const card = document.createElement('div');
          card.className = 'bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-lg transition';
          card.onclick = () => showConversation(session.id, session.title);

          const flexDiv = document.createElement('div');
          flexDiv.className = 'flex justify-between items-start';

          const contentDiv = document.createElement('div');
          contentDiv.className = 'flex-1';

          const titleH3 = document.createElement('h3');
          titleH3.className = 'font-bold text-lg text-blue-900';
          titleH3.textContent = session.title;

          const userP = document.createElement('p');
          userP.className = 'text-gray-600 text-sm';
          userP.textContent = `${session.user_name} (${session.user_email})`;

          const dateP = document.createElement('p');
          dateP.className = 'text-gray-500 text-sm mt-2';
          dateP.textContent = `${new Date(session.started_at).toLocaleDateString('fr-FR')} - ${session.message_count} message(s)`;

          contentDiv.appendChild(titleH3);
          contentDiv.appendChild(userP);
          contentDiv.appendChild(dateP);
          flexDiv.appendChild(contentDiv);
          card.appendChild(flexDiv);
          list.appendChild(card);
        });

        renderPagination(data.page, data.pages);
      } catch (error) {
        showError('Erreur lors du chargement des conversations: ' + error.message);
      }
    }

    function renderPagination(page, totalPages) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Bouton précédent
      if (page > 1) {
        const prev = document.createElement('button');
        prev.textContent = '← Précédent';
        prev.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
        prev.onclick = () => {
          currentPage--;
          loadAllConversations();
        };
        pagination.appendChild(prev);
      }

      // Numéros de pages
      for (let i = 1; i <= totalPages; i++) {
        if (i === page || i === 1 || i === totalPages || Math.abs(i - page) <= 2) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = i;
          pageBtn.className = i === page
            ? 'px-4 py-2 bg-blue-900 text-white rounded'
            : 'px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400';
          pageBtn.onclick = () => {
            currentPage = i;
            loadAllConversations();
          };
          pagination.appendChild(pageBtn);
        } else if (Math.abs(i - page) === 3) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'px-2';
          pagination.appendChild(dots);
        }
      }

      // Bouton suivant
      if (page < totalPages) {
        const next = document.createElement('button');
        next.textContent = 'Suivant →';
        next.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
        next.onclick = () => {
          currentPage++;
          loadAllConversations();
        };
        pagination.appendChild(next);
      }
    }

    async function showConversation(sessionId, title) {
      if (!adminKey) return;

      currentSessionId = sessionId;

      try {
        const response = await fetch(`/api/admin-conversations?action=messages&sessionId=${sessionId}`, {
          headers: { 'X-Admin-Key': adminKey }
        });
        const data = await response.json();

        document.getElementById('modalTitle').textContent = title;
        const content = document.getElementById('modalContent');
        content.innerHTML = '';

        if (!data.messages || data.messages.length === 0) {
          content.innerHTML = '<p class="text-gray-500">Aucun message dans cette conversation</p>';
        } else {
          data.messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.className = msg.role === 'user'
              ? 'bg-blue-50 p-4 rounded-lg'
              : 'bg-gray-50 p-4 rounded-lg';

            const roleDiv = document.createElement('div');
            roleDiv.className = `font-bold text-sm mb-2 ${msg.role === 'user' ? 'text-blue-900' : 'text-gray-700'}`;
            roleDiv.textContent = msg.role === 'user' ? 'Question' : 'Réponse';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'text-gray-800';
            contentDiv.textContent = msg.content;

            const dateDiv = document.createElement('div');
            dateDiv.className = 'text-xs text-gray-500 mt-2';
            dateDiv.textContent = new Date(msg.created_at).toLocaleString('fr-FR');

            msgDiv.appendChild(roleDiv);
            msgDiv.appendChild(contentDiv);
            msgDiv.appendChild(dateDiv);
            content.appendChild(msgDiv);
          });
        }

        document.getElementById('conversationModal').classList.remove('hidden');
      } catch (error) {
        showError('Erreur lors du chargement de la conversation: ' + error.message);
      }
    }

    function closeConversationModal() {
      document.getElementById('conversationModal').classList.add('hidden');
      currentSessionId = null;
    }

    async function deleteConversation() {
      if (!currentSessionId || !adminKey) return;

      if (!confirm('Êtes-vous sûr de vouloir supprimer cette conversation ?')) return;

      try {
        await fetch(`/api/admin-conversations?sessionId=${currentSessionId}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Key': adminKey }
        });

        closeConversationModal();
        loadAllConversations();
      } catch (error) {
        showError('Erreur lors de la suppression: ' + error.message);
      }
    }

    async function exportConversations() {
      if (!adminKey) return;

      const dateFilter = document.getElementById('dateFilter').value;
      window.location.href = `/api/admin-conversations?action=export&dateFilter=${dateFilter}&adminKey=${adminKey}`;
    }

    // ====================================
    // FONCTIONS CONVERSATIONS ANONYMES
    // ====================================

    let currentAnonymousPage = 1;

    /**
     * Charger les conversations anonymes
     */
    async function loadAnonymousConversations(page = 1) {
      if (!adminKey) return;

      currentAnonymousPage = page;
      const dateFilter = document.getElementById('dateFilter').value;

      try {
        const response = await fetch(
          `/api/admin-conversations?action=listAnonymous&page=${page}&limit=50&dateFilter=${dateFilter}`,
          {
            headers: {
              'X-Admin-Key': adminKey
            }
          }
        );

        const data = await response.json();

        if (data.success) {
          renderAnonymousConversations(data.conversations);
          renderAnonymousPagination(data.pagination);

          // Mettre à jour le compteur
          document.getElementById('anonymousCount').textContent = data.pagination.total;
        } else {
          showError('Erreur: ' + data.error);
        }

      } catch (error) {
        console.error('Erreur chargement conversations anonymes:', error);
        showError('Erreur chargement conversations');
      }
    }

    /**
     * Parser le User-Agent pour afficher le navigateur
     */
    function parseUserAgent(ua) {
      if (!ua || ua === 'Unknown') return 'Inconnu';

      // Détecter le navigateur
      if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Edg')) return 'Edge';
      if (ua.includes('Opera') || ua.includes('OPR')) return 'Opera';

      return 'Autre';
    }

    /**
     * Masquer partiellement l'IP pour RGPD
     */
    function maskIP(ip) {
      if (!ip) return 'N/A';
      const parts = ip.split('.');
      if (parts.length === 4) {
        // Masquer le dernier octet : xxx.xxx.xxx.***
        return `${parts[0]}.${parts[1]}.${parts[2]}.***`;
      }
      return ip; // IPv6 ou autre format
    }

    /**
     * Afficher les conversations anonymes
     */
    function renderAnonymousConversations(conversations) {
      const tbody = document.getElementById('anonymousConversationsList');
      tbody.innerHTML = '';

      if (conversations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
              Aucune conversation anonyme trouvée
            </td>
          </tr>
        `;
        return;
      }

      conversations.forEach(conv => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        // Tronquer l'identifiant anonyme
        const shortId = conv.anonymousIdentifier.substring(0, 8) + '...';

        // Échapper le titre pour éviter les problèmes avec les guillemets
        const escapedTitle = (conv.title || 'Sans titre').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${conv.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" title="${conv.anonymousIdentifier}">
            ${shortId}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${maskIP(conv.ipAddress)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${parseUserAgent(conv.userAgent)}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
            ${conv.title}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${conv.messageCount}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${new Date(conv.lastMessageAt).toLocaleDateString('fr-FR')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
            <button onclick="showConversation(${conv.id}, '${escapedTitle}')" class="text-blue-600 hover:text-blue-900">
              Voir
            </button>
            <button onclick="deleteAnonymousConversation(${conv.id})" class="text-red-600 hover:text-red-900">
              Supprimer
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    /**
     * Afficher la pagination pour anonymes
     */
    function renderAnonymousPagination(pagination) {
      const container = document.getElementById('anonymousPagination');
      container.innerHTML = '';

      if (pagination.totalPages <= 1) return;

      for (let i = 1; i <= pagination.totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === pagination.page
          ? 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          : 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
        btn.onclick = () => loadAnonymousConversations(i);
        container.appendChild(btn);
      }
    }

    /**
     * Supprimer une conversation anonyme
     */
    async function deleteAnonymousConversation(sessionId) {
      if (!adminKey) return;

      if (!confirm('Êtes-vous sûr de vouloir supprimer cette conversation anonyme ?')) return;

      try {
        await fetch(`/api/admin-conversations?sessionId=${sessionId}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Key': adminKey }
        });

        // Recharger la liste
        loadAnonymousConversations(currentAnonymousPage);
      } catch (error) {
        showError('Erreur lors de la suppression: ' + error.message);
      }
    }

    // Event listeners pour les filtres
    document.getElementById('dateFilter').addEventListener('change', () => {
      currentPage = 1;
      loadAllConversations();
    });

    document.getElementById('userFilter').addEventListener('change', () => {
      currentPage = 1;
      loadAllConversations();
    });
  </script>
</body>
</html>