<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - sosdivorce.fr</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'system-ui', sans-serif; }
    .tab-button.active {
      color: #1e3a8a;
      border-bottom-color: #1e3a8a;
    }
    .tab-content.hidden {
      display: none;
    }
    .sub-tab-button.active {
      background-color: #2563eb;
      color: white;
    }
    .view-content.hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Modal de connexion admin -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-blue-900 mb-6">Authentification Admin</h2>
      <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Clé Admin</label>
          <input
            type="password"
            id="adminKeyInput"
            required
            placeholder="Entrez votre clé admin"
            class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
          Se connecter
        </button>
      </form>
    </div>
  </div>

  <!-- Contenu admin (caché par défaut) -->
  <div id="adminContent" class="hidden">
    <div class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-blue-900">Administration - sosdivorce.fr</h1>
          <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            Déconnexion
          </button>
        </div>

        <!-- Onglets -->
        <div class="mb-8">
          <div class="flex border-b border-gray-300">
            <button id="tabStats" class="tab-button active px-6 py-3 font-semibold text-blue-900 border-b-2 border-blue-900">
              Statistiques
            </button>
            <button id="tabConversations" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-900">
              Conversations
            </button>
            <button id="tabPayments" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-900">
              Paiements
            </button>
            <button id="tabSettings" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-900">
              Paramètres
            </button>
          </div>
        </div>

        <!-- Contenu Onglet Statistiques -->
        <div id="contentStats" class="tab-content">

      <!-- Statistiques de Conversion -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tunnel de Conversion</h2>

        <!-- Statistiques Globales -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Statistiques Globales (Tous les temps)</h3>
          <div class="grid md:grid-cols-3 gap-6">
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Premiers Messages</h4>
              <p id="globalFirstMessages" class="text-3xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Emails Collectés</h4>
              <p id="globalEmailsCollected" class="text-3xl font-bold text-green-600">-</p>
              <p id="globalEmailRate" class="text-xs text-gray-500 mt-1">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Paiements Complétés</h4>
              <p id="globalPaymentsCompleted" class="text-3xl font-bold text-purple-600">-</p>
              <p id="globalPaymentRate" class="text-xs text-gray-500 mt-1">-</p>
            </div>
          </div>
          <div class="mt-4 bg-white p-4 rounded-lg shadow">
            <h4 class="text-sm font-medium text-gray-600 mb-1">Taux de Conversion Global (Message → Paiement)</h4>
            <p id="globalTotalConversion" class="text-4xl font-bold text-indigo-600">-</p>
          </div>
        </div>

        <!-- Statistiques 7 derniers jours -->
        <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">7 Derniers Jours</h3>
          <div class="grid md:grid-cols-3 gap-6">
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Premiers Messages</h4>
              <p id="last7DaysFirstMessages" class="text-3xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Emails Collectés</h4>
              <p id="last7DaysEmailsCollected" class="text-3xl font-bold text-green-600">-</p>
              <p id="last7DaysEmailRate" class="text-xs text-gray-500 mt-1">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h4 class="text-sm font-medium text-gray-600 mb-1">Paiements Complétés</h4>
              <p id="last7DaysPaymentsCompleted" class="text-3xl font-bold text-purple-600">-</p>
              <p id="last7DaysPaymentRate" class="text-xs text-gray-500 mt-1">-</p>
            </div>
          </div>
          <div class="mt-4 bg-white p-4 rounded-lg shadow">
            <h4 class="text-sm font-medium text-gray-600 mb-1">Taux de Conversion 7j (Message → Paiement)</h4>
            <p id="last7DaysTotalConversion" class="text-4xl font-bold text-indigo-600">-</p>
          </div>
        </div>

        <!-- Graphique par jour (tableau simple) -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Détails par Jour (30 derniers jours)</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Date</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">1ers Messages</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">Emails</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">Paiements</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">Taux Email</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">Taux Paiement</th>
                  <th class="px-4 py-2 text-right text-sm font-semibold text-gray-700">Conversion Totale</th>
                </tr>
              </thead>
              <tbody id="dailyStatsTable">
                <tr>
                  <td colspan="7" class="px-4 py-8 text-center text-gray-500">Chargement...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

        </div>
        <!-- Fin Contenu Onglet Statistiques -->

        <!-- Contenu Onglet Conversations -->
        <div id="contentConversations" class="tab-content hidden">
          <!-- Stats rapides -->
          <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-indigo-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-indigo-900">Total Conversations</h3>
              <p id="convTotalCount" class="text-2xl font-bold text-indigo-600">-</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-green-900">Sessions Payees</h3>
              <p id="convPaidCount" class="text-2xl font-bold text-green-600">-</p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-yellow-900">Sessions Non Payees</h3>
              <p id="convUnpaidCount" class="text-2xl font-bold text-yellow-600">-</p>
            </div>
          </div>

          <!-- Filtres -->
          <div class="mb-6 flex gap-4 items-center">
            <button onclick="loadAllConversations()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              Actualiser
            </button>
            <select id="convTypeFilter" onchange="filterConversations()" class="border rounded px-3 py-2 text-gray-700">
              <option value="all">Toutes les conversations</option>
              <option value="paid">Sessions payees uniquement</option>
              <option value="unpaid">Sessions non payees uniquement</option>
            </select>
          </div>

          <!-- Tableau des conversations -->
          <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Formule</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Messages</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="conversationsList" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="6" class="px-6 py-8 text-center text-gray-500">Chargement...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Modal Conversation -->
          <div id="conversationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="flex justify-center min-h-screen p-4">
              <div class="bg-white rounded-lg max-w-4xl w-full my-auto p-8">
                <div class="flex justify-between items-center mb-6">
                  <h2 id="convModalTitle" class="text-2xl font-bold text-blue-900">Conversation</h2>
                  <button onclick="closeConversationModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <!-- Infos session -->
                <div class="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                  <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p id="convModalEmail" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Type</p>
                    <p id="convModalType" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Formule</p>
                    <p id="convModalExpertise" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Date</p>
                    <p id="convModalDate" class="font-semibold">-</p>
                  </div>
                </div>

                <!-- Messages -->
                <h3 class="text-lg font-semibold mb-4">Messages</h3>
                <div id="convModalMessages" class="space-y-4 max-h-96 overflow-y-auto">
                </div>

                <div class="mt-6">
                  <button onclick="closeConversationModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                    Fermer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Fin Contenu Onglet Conversations -->

        <!-- Contenu Onglet Paiements -->
        <div id="contentPayments" class="tab-content hidden">
          <!-- Sous-onglets Paiements -->
          <div class="mb-6">
            <div class="flex gap-4">
              <button id="viewPaidSessions" class="sub-tab-button active px-4 py-2 bg-blue-600 text-white rounded">
                Sessions payées
              </button>
              <button id="viewUnpaidWithEmail" class="sub-tab-button px-4 py-2 bg-gray-300 text-gray-700 rounded">
                Emails collectés (non payés)
              </button>
            </div>
          </div>

          <!-- Vue Sessions Payées -->
          <div id="viewPaidSessionsContent" class="view-content">
          <!-- Statistiques Paiements -->
          <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-green-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-green-900">Revenus Totaux</h3>
              <p id="totalRevenue" class="text-2xl font-bold text-green-600">-</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-900">Sessions Payées</h3>
              <p id="totalPaidSessions" class="text-2xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-purple-900">Analyses Express</h3>
              <p id="expressCount" class="text-2xl font-bold text-purple-600">-</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-orange-900">Analyses Premium</h3>
              <p id="premiumCount" class="text-2xl font-bold text-orange-600">-</p>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="mb-6 flex gap-4">
            <button onclick="loadPaymentStats()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              Actualiser
            </button>
            <button onclick="exportPayments()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
              Exporter CSV
            </button>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="paidOnlyFilter" onchange="loadPaidSessions()" checked>
              <span class="text-gray-700">Afficher uniquement les sessions payées</span>
            </label>
          </div>

          <!-- Liste des sessions payées -->
          <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Formule</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Paiement</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="paidSessionsList" class="bg-white divide-y divide-gray-200">
                <!-- Rempli dynamiquement -->
              </tbody>
            </table>
          </div>

          <!-- Pagination paiements -->
          <div id="paymentsPagination" class="flex justify-center gap-2 mt-6">
            <!-- Boutons de pagination -->
          </div>

          <!-- Modal Détail Session Payée -->
          <div id="paidSessionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="flex justify-center min-h-screen p-4">
              <div class="bg-white rounded-lg max-w-4xl w-full my-auto p-8">
                <div class="flex justify-between items-center mb-6">
                  <h2 id="paidModalTitle" class="text-2xl font-bold text-blue-900">Détail de la session</h2>
                  <button onclick="closePaidSessionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <!-- Infos session -->
                <div class="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                  <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p id="paidModalEmail" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Formule</p>
                    <p id="paidModalExpertise" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Montant</p>
                    <p id="paidModalAmount" class="font-semibold">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Date paiement</p>
                    <p id="paidModalDate" class="font-semibold">-</p>
                  </div>
                </div>

                <!-- Messages de la conversation -->
                <h3 class="text-lg font-semibold mb-4">Conversation</h3>
                <div id="paidModalMessages" class="space-y-4 max-h-96 overflow-y-auto">
                  <!-- Messages -->
                </div>

                <div class="mt-6 flex gap-4">
                  <button onclick="closePaidSessionModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                    Fermer
                  </button>
                </div>
              </div>
            </div>
          </div>
          </div>
          <!-- Fin Vue Sessions Payées -->

          <!-- Vue Sessions Non Payées avec Email -->
          <div id="viewUnpaidWithEmailContent" class="view-content hidden">
            <!-- Statistiques Unpaid -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-yellow-900">Emails collectés (non payés)</h3>
                <p id="unpaidWithEmailCount" class="text-2xl font-bold text-yellow-600">-</p>
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-900">Taux de conversion</h3>
                <p id="conversionRate" class="text-2xl font-bold text-blue-600">-</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-green-900">Aujourd'hui</h3>
                <p id="unpaidToday" class="text-2xl font-bold text-green-600">-</p>
              </div>
            </div>

            <!-- Actions Unpaid -->
            <div class="mb-6 flex gap-4">
              <button onclick="loadUnpaidSessions()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Actualiser
              </button>
              <button onclick="exportUnpaidSessions()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Exporter CSV
              </button>
            </div>

            <!-- Table Sessions Unpaid -->
            <div class="bg-white rounded-lg shadow overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Formule</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date collecte</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Messages</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tentatives</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="unpaidSessionsList" class="bg-white divide-y divide-gray-200">
                  <!-- Rempli dynamiquement -->
                </tbody>
              </table>
            </div>

            <!-- Pagination unpaid -->
            <div id="unpaidPagination" class="flex justify-center gap-2 mt-6">
              <!-- Boutons de pagination -->
            </div>

            <!-- Modal Détail Session Unpaid -->
            <div id="unpaidSessionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
              <div class="flex justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-4xl w-full my-auto p-8">
                  <div class="flex justify-between items-center mb-6">
                    <h2 id="unpaidModalTitle" class="text-2xl font-bold text-blue-900">Détail de la session non payée</h2>
                    <button onclick="closeUnpaidSessionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                  </div>

                  <!-- Infos session unpaid -->
                  <div class="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                    <div>
                      <p class="text-sm text-gray-500">Email</p>
                      <p id="unpaidModalEmail" class="font-semibold">-</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Formule sélectionnée</p>
                      <p id="unpaidModalExpertise" class="font-semibold">-</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Date collecte email</p>
                      <p id="unpaidModalCollectDate" class="font-semibold">-</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Tentatives de paiement</p>
                      <p id="unpaidModalAttempts" class="font-semibold">-</p>
                    </div>
                  </div>

                  <!-- Messages de la conversation -->
                  <h3 class="text-lg font-semibold mb-4">Conversation</h3>
                  <div id="unpaidModalMessages" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Messages -->
                  </div>

                  <div class="mt-6 flex gap-4">
                    <button onclick="closeUnpaidSessionModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                      Fermer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fin Vue Sessions Non Payées -->

        </div>
        <!-- Fin Contenu Onglet Paiements -->

        <!-- Contenu Onglet Paramètres -->
        <div id="contentSettings" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-6">Paramètres du site</h2>

          <!-- Section Mode Maintenance -->
          <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900">Mode Maintenance</h3>
                <p class="text-gray-600 text-sm mt-1">
                  Lorsque le mode maintenance est activé, les visiteurs voient une page de maintenance et doivent entrer le code d'accès pour accéder au site.
                </p>
                <p id="maintenanceStatusText" class="mt-2 text-sm font-medium">
                  <!-- Rempli dynamiquement -->
                </p>
              </div>
              <div class="flex items-center gap-4">
                <span id="maintenanceStatus" class="px-3 py-1 rounded-full text-sm font-medium">
                  <!-- Rempli dynamiquement -->
                </span>
                <button id="toggleMaintenanceBtn" onclick="toggleMaintenance()" class="px-6 py-2 rounded-lg font-medium transition-colors">
                  <!-- Rempli dynamiquement -->
                </button>
              </div>
            </div>
          </div>

          <!-- Informations supplémentaires -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-semibold text-blue-900 mb-2">Code d'accès maintenance</h4>
            <p class="text-blue-800">
              Le code d'accès pour bypasser la page maintenance est : <code class="bg-blue-100 px-2 py-1 rounded font-mono">789654123</code>
            </p>
            <p class="text-blue-700 text-sm mt-2">
              Ce code permet aux administrateurs et testeurs d'accéder au site même en mode maintenance.
            </p>
          </div>
        </div>
        <!-- Fin Contenu Onglet Paramètres -->

      </div>
    </div>
  </div>

  <script>
    let adminKey = null;

    // Vérifier si déjà connecté au chargement
    document.addEventListener('DOMContentLoaded', function() {
      const savedKey = sessionStorage.getItem('adminKey');
      if (savedKey) {
        // Vérifier si la clé est toujours valide
        adminKey = savedKey;
        testAdminKey(savedKey);
      }
    });

    async function handleLogin(event) {
      event.preventDefault();
      const testKey = document.getElementById('adminKeyInput').value;

      try {
        // Tester la clé admin en appelant les stats
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': testKey
          },
          body: JSON.stringify({ action: 'stats', adminKey: testKey })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          adminKey = testKey;
          sessionStorage.setItem('adminKey', testKey);
          showAdminContent();
          loadStats();
        } else {
          throw new Error('Clé admin invalide');
        }
      } catch (error) {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = 'Clé admin invalide. Veuillez réessayer.';
        errorDiv.classList.remove('hidden');
      }
    }

    async function testAdminKey(key) {
      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': key
          },
          body: JSON.stringify({ action: 'stats', adminKey: key })
        });

        if (response.ok) {
          showAdminContent();
          loadStats();
        } else {
          // Clé invalide, afficher le modal
          sessionStorage.removeItem('adminKey');
          adminKey = null;
        }
      } catch (error) {
        sessionStorage.removeItem('adminKey');
        adminKey = null;
      }
    }

    function showAdminContent() {
      document.getElementById('authModal').classList.add('hidden');
      document.getElementById('adminContent').classList.remove('hidden');
    }

    function logout() {
      adminKey = null;
      sessionStorage.removeItem('adminKey');
      document.getElementById('authModal').classList.remove('hidden');
      document.getElementById('adminContent').classList.add('hidden');
      document.getElementById('adminKeyInput').value = '';
    }

    async function loadStats() {
      if (!adminKey) return;

      try {
        // Charger uniquement les statistiques de conversion
        await loadConversionStats();

      } catch (error) {
        console.error('Erreur loadStats:', error);
      }
    }

    async function loadConversionStats() {
      if (!adminKey) {
        console.log('Pas de clé admin, impossible de charger les stats');
        return;
      }

      try {
        console.log('Chargement des statistiques de conversion...');
        const response = await fetch('/api/admin-statistics?days=30', {
          method: 'GET',
          headers: {
            'X-Admin-Password': adminKey
          }
        });

        console.log('Réponse reçue:', response.status);
        const data = await response.json();
        console.log('Données:', data);

        if (response.status === 401) {
          console.error('Non autorisé pour les statistiques de conversion');
          document.getElementById('dailyStatsTable').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-orange-500">Non autorisé - Vérifiez votre clé admin</td></tr>';
          return;
        }

        if (!data.success) {
          console.error('Erreur API:', data.error);
          document.getElementById('dailyStatsTable').innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Erreur: ${data.error || 'Erreur inconnue'}</td></tr>`;
          return;
        }

        if (data.success) {
          // Statistiques globales
          document.getElementById('globalFirstMessages').textContent = data.global.total_first_messages.toLocaleString();
          document.getElementById('globalEmailsCollected').textContent = data.global.total_emails_collected.toLocaleString();
          document.getElementById('globalPaymentsCompleted').textContent = data.global.total_payments_completed.toLocaleString();
          document.getElementById('globalEmailRate').textContent = `${data.global.email_conversion_rate}% des messages`;
          document.getElementById('globalPaymentRate').textContent = `${data.global.payment_conversion_rate}% des emails`;
          document.getElementById('globalTotalConversion').textContent = `${data.global.total_conversion_rate}%`;

          // Statistiques 7 derniers jours
          document.getElementById('last7DaysFirstMessages').textContent = data.last7Days.first_messages.toLocaleString();
          document.getElementById('last7DaysEmailsCollected').textContent = data.last7Days.emails_collected.toLocaleString();
          document.getElementById('last7DaysPaymentsCompleted').textContent = data.last7Days.payments_completed.toLocaleString();
          document.getElementById('last7DaysEmailRate').textContent = `${data.last7Days.email_conversion_rate}% des messages`;
          document.getElementById('last7DaysPaymentRate').textContent = `${data.last7Days.payment_conversion_rate}% des emails`;
          document.getElementById('last7DaysTotalConversion').textContent = `${data.last7Days.total_conversion_rate}%`;

          // Tableau des statistiques journalières
          const tableBody = document.getElementById('dailyStatsTable');
          if (data.daily && data.daily.length > 0) {
            tableBody.innerHTML = data.daily.map(day => `
              <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-2 text-sm">${new Date(day.date).toLocaleDateString('fr-FR')}</td>
                <td class="px-4 py-2 text-sm text-right">${day.first_messages}</td>
                <td class="px-4 py-2 text-sm text-right">${day.emails_collected}</td>
                <td class="px-4 py-2 text-sm text-right">${day.payments_completed}</td>
                <td class="px-4 py-2 text-sm text-right ${day.email_conversion_rate > 50 ? 'text-green-600 font-semibold' : ''}">${day.email_conversion_rate}%</td>
                <td class="px-4 py-2 text-sm text-right ${day.payment_conversion_rate > 30 ? 'text-green-600 font-semibold' : ''}">${day.payment_conversion_rate}%</td>
                <td class="px-4 py-2 text-sm text-right ${day.total_conversion_rate > 10 ? 'text-green-600 font-semibold' : ''}">${day.total_conversion_rate}%</td>
              </tr>
            `).join('');
          } else {
            tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Aucune donnée disponible</td></tr>';
          }
        }
      } catch (error) {
        console.error('Erreur chargement statistiques de conversion:', error);
        document.getElementById('dailyStatsTable').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Erreur de chargement</td></tr>';
      }
    }

    async function loadUsers() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'list', adminKey: adminKey })
        });

        const data = await response.json();

        if (response.status === 403) {
          // Session expirée, demander reconnexion
          logout();
          throw new Error('Session expirée. Veuillez vous reconnecter.');
        }

        if (data.success) {
          displayUsers(data.users);
        } else {
          throw new Error(data.error || 'Erreur lors du chargement des utilisateurs');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    function displayUsers(users) {
      const usersList = document.getElementById('usersList');

      // Vider la liste
      usersList.innerHTML = '';

      if (users.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'text-gray-500';
        emptyMsg.textContent = 'Aucun utilisateur inscrit';
        usersList.appendChild(emptyMsg);
        return;
      }

      // Créer les éléments DOM de manière sûre (sans innerHTML)
      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'bg-gray-50 p-4 rounded-lg border';

        const flexDiv = document.createElement('div');
        flexDiv.className = 'flex justify-between items-start';

        const infoDiv = document.createElement('div');

        const nameH4 = document.createElement('h4');
        nameH4.className = 'font-semibold text-gray-800';
        nameH4.textContent = `${user.firstName} ${user.lastName}`;

        const emailP = document.createElement('p');
        emailP.className = 'text-gray-600';
        emailP.textContent = user.email;

        const dateP = document.createElement('p');
        dateP.className = 'text-sm text-gray-500';
        dateP.textContent = `Inscrit le: ${new Date(user.registeredAt).toLocaleDateString('fr-FR')}`;

        const idDiv = document.createElement('div');
        idDiv.className = 'text-sm text-gray-500';
        idDiv.textContent = `ID: ${user.id}`;

        infoDiv.appendChild(nameH4);
        infoDiv.appendChild(emailP);
        infoDiv.appendChild(dateP);

        flexDiv.appendChild(infoDiv);
        flexDiv.appendChild(idDiv);

        userDiv.appendChild(flexDiv);
        usersList.appendChild(userDiv);
      });
    }

    function showError(message) {
      // Afficher l'erreur dans la console au lieu d'un élément HTML supprimé
      console.error('Erreur admin:', message);
      alert(message); // Afficher aussi une alerte pour l'utilisateur
    }

    // Gestion des onglets principaux
    document.getElementById('tabStats').addEventListener('click', () => {
      switchTab('Stats');
    });

    document.getElementById('tabConversations').addEventListener('click', () => {
      switchTab('Conversations');
      loadAllConversations();
    });

    document.getElementById('tabPayments').addEventListener('click', () => {
      switchTab('Payments');
      loadPaymentStats();
      loadPaidSessions();
    });

    document.getElementById('tabSettings').addEventListener('click', () => {
      switchTab('Settings');
      loadMaintenanceStatus();
    });

    function switchTab(tab) {
      // Désactiver tous les onglets
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-b-2', 'border-blue-900', 'text-blue-900');
        btn.classList.add('text-gray-600');
      });
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

      // Activer l'onglet sélectionné
      const activeTab = document.getElementById(`tab${tab}`);
      activeTab.classList.add('active', 'border-b-2', 'border-blue-900', 'text-blue-900');
      activeTab.classList.remove('text-gray-600');
      document.getElementById(`content${tab}`).classList.remove('hidden');
    }

    // ====================================
    // FONCTIONS PAIEMENTS
    // ====================================

    let currentPaymentsPage = 1;
    let currentPaidSessionId = null;

    /**
     * Charger les statistiques de paiements
     */
    async function loadPaymentStats() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/admin-payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'stats', adminKey })
        });

        const data = await response.json();

        if (data.success && data.stats) {
          const stats = data.stats;

          // Formater les revenus en euros
          const revenueEuros = (stats.totalRevenue / 100).toFixed(2);
          document.getElementById('totalRevenue').textContent = `${revenueEuros} €`;
          document.getElementById('totalPaidSessions').textContent = stats.paidSessions || 0;
          document.getElementById('expressCount').textContent = stats.classiqueCount || 0;
          document.getElementById('premiumCount').textContent = stats.premiumCount || 0;
        }
      } catch (error) {
        showError('Erreur chargement statistiques paiements: ' + error.message);
      }
    }

    /**
     * Charger les sessions payées
     */
    async function loadPaidSessions(page = 1) {
      if (!adminKey) return;

      currentPaymentsPage = page;
      const paidOnly = document.getElementById('paidOnlyFilter').checked;

      try {
        const response = await fetch('/api/admin-payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({
            action: 'list',
            adminKey,
            page,
            limit: 50,
            paidOnly
          })
        });

        const data = await response.json();

        if (data.success) {
          renderPaidSessions(data.sessions || []);
          renderPaymentsPagination(data.pagination);
        }
      } catch (error) {
        showError('Erreur chargement sessions: ' + error.message);
      }
    }

    /**
     * Afficher les sessions payées dans le tableau
     */
    function renderPaidSessions(sessions) {
      const tbody = document.getElementById('paidSessionsList');
      tbody.innerHTML = '';

      if (sessions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
              Aucune session trouvée
            </td>
          </tr>
        `;
        return;
      }

      sessions.forEach(session => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        // Formater le montant
        const amountEuros = session.amount ? (session.amount / 100).toFixed(2) + ' €' : '-';

        // Formater la date
        const paidDate = session.paidAt
          ? new Date(session.paidAt).toLocaleDateString('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })
          : '-';

        // Badge expertise
        let expertiseBadge = '-';
        if (session.expertise === 'classique') {
          expertiseBadge = '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Express</span>';
        } else if (session.expertise === 'premium') {
          expertiseBadge = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">Premium</span>';
        }

        // Badge statut
        const statusBadge = session.paid
          ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Payé</span>'
          : '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">En attente</span>';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${session.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${session.email || 'Non renseigné'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${expertiseBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${amountEuros}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${paidDate}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="showPaidSession('${session.sessionUuid}')" class="text-blue-600 hover:text-blue-900">
              Voir détails
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    /**
     * Pagination des paiements
     */
    function renderPaymentsPagination(pagination) {
      const container = document.getElementById('paymentsPagination');
      container.innerHTML = '';

      if (!pagination || pagination.totalPages <= 1) return;

      for (let i = 1; i <= pagination.totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === pagination.page
          ? 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          : 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
        btn.onclick = () => loadPaidSessions(i);
        container.appendChild(btn);
      }
    }

    /**
     * Afficher le détail d'une session payée
     */
    async function showPaidSession(sessionUuid) {
      if (!adminKey) return;

      currentPaidSessionId = sessionUuid;

      try {
        const response = await fetch('/api/admin-payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({
            action: 'messages',
            adminKey,
            sessionId: sessionUuid
          })
        });

        const data = await response.json();

        if (data.success) {
          const session = data.session;
          const messages = data.messages || [];

          // Remplir les infos session
          document.getElementById('paidModalEmail').textContent = session.email || 'Non renseigné';

          let expertiseText = '-';
          if (session.expertise === 'classique') expertiseText = 'Analyse Express (29€)';
          else if (session.expertise === 'premium') expertiseText = 'Analyse Premium (49€)';
          document.getElementById('paidModalExpertise').textContent = expertiseText;

          const amountEuros = session.amount ? (session.amount / 100).toFixed(2) + ' €' : '-';
          document.getElementById('paidModalAmount').textContent = amountEuros;

          const paidDate = session.paidAt
            ? new Date(session.paidAt).toLocaleString('fr-FR')
            : 'Non payé';
          document.getElementById('paidModalDate').textContent = paidDate;

          // Afficher les messages
          const messagesContainer = document.getElementById('paidModalMessages');
          messagesContainer.innerHTML = '';

          if (messages.length === 0) {
            messagesContainer.innerHTML = '<p class="text-gray-500">Aucun message dans cette conversation</p>';
          } else {
            messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = msg.role === 'user'
                ? 'bg-blue-50 p-4 rounded-lg'
                : 'bg-gray-50 p-4 rounded-lg';

              const roleDiv = document.createElement('div');
              roleDiv.className = `font-bold text-sm mb-2 ${msg.role === 'user' ? 'text-blue-900' : 'text-gray-700'}`;
              roleDiv.textContent = msg.role === 'user' ? 'Utilisateur' : 'Assistant';

              const contentDiv = document.createElement('div');
              contentDiv.className = 'text-gray-800 whitespace-pre-wrap';
              contentDiv.textContent = msg.content;

              const dateDiv = document.createElement('div');
              dateDiv.className = 'text-xs text-gray-500 mt-2';
              dateDiv.textContent = new Date(msg.created_at).toLocaleString('fr-FR');

              msgDiv.appendChild(roleDiv);
              msgDiv.appendChild(contentDiv);
              msgDiv.appendChild(dateDiv);
              messagesContainer.appendChild(msgDiv);
            });
          }

          // Afficher le modal
          document.getElementById('paidSessionModal').classList.remove('hidden');
        }
      } catch (error) {
        showError('Erreur chargement détail session: ' + error.message);
      }
    }

    /**
     * Fermer le modal session payée
     */
    function closePaidSessionModal() {
      document.getElementById('paidSessionModal').classList.add('hidden');
      currentPaidSessionId = null;
    }

    /**
     * Exporter les paiements en CSV
     */
    function exportPayments() {
      if (!adminKey) return;
      window.location.href = `/api/admin-payments?action=export&adminKey=${adminKey}`;
    }

    // ====================================
    // FONCTIONS MODE MAINTENANCE
    // ====================================

    let maintenanceEnabled = true;

    /**
     * Charger l'état actuel du mode maintenance
     */
    async function loadMaintenanceStatus() {
      try {
        const response = await fetch('/api/maintenance');
        const data = await response.json();

        if (data.success) {
          maintenanceEnabled = data.maintenanceEnabled;
          updateMaintenanceUI();
        }
      } catch (error) {
        showError('Erreur chargement état maintenance: ' + error.message);
      }
    }

    /**
     * Mettre à jour l'interface selon l'état maintenance
     */
    function updateMaintenanceUI() {
      const statusBadge = document.getElementById('maintenanceStatus');
      const statusText = document.getElementById('maintenanceStatusText');
      const toggleBtn = document.getElementById('toggleMaintenanceBtn');

      if (maintenanceEnabled) {
        statusBadge.textContent = 'ACTIVÉ';
        statusBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
        statusText.textContent = 'Le site affiche actuellement la page de maintenance aux visiteurs.';
        statusText.className = 'mt-2 text-sm font-medium text-red-600';
        toggleBtn.textContent = 'Désactiver';
        toggleBtn.className = 'px-6 py-2 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
      } else {
        statusBadge.textContent = 'DÉSACTIVÉ';
        statusBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
        statusText.textContent = 'Le site est accessible normalement à tous les visiteurs.';
        statusText.className = 'mt-2 text-sm font-medium text-green-600';
        toggleBtn.textContent = 'Activer';
        toggleBtn.className = 'px-6 py-2 rounded-lg font-medium transition-colors bg-red-600 text-white hover:bg-red-700';
      }
    }

    /**
     * Basculer le mode maintenance
     */
    async function toggleMaintenance() {
      if (!adminKey) {
        showError('Vous devez être connecté pour modifier le mode maintenance');
        return;
      }

      const newState = !maintenanceEnabled;
      const action = newState ? 'activer' : 'désactiver';

      if (!confirm(`Êtes-vous sûr de vouloir ${action} le mode maintenance ?`)) {
        return;
      }

      try {
        const response = await fetch('/api/maintenance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ enabled: newState })
        });

        const data = await response.json();

        if (data.success) {
          maintenanceEnabled = data.maintenanceEnabled;
          updateMaintenanceUI();

          // Afficher un message de confirmation
          const message = maintenanceEnabled
            ? 'Mode maintenance activé. Les visiteurs verront la page de maintenance.'
            : 'Mode maintenance désactivé. Le site est maintenant accessible à tous.';
          alert(message);
        } else {
          throw new Error(data.error || 'Erreur lors de la modification');
        }
      } catch (error) {
        showError('Erreur modification maintenance: ' + error.message);
      }
    }

    // ====================================
    // FONCTIONS SESSIONS NON PAYÉES AVEC EMAIL
    // ====================================

    let currentUnpaidPage = 1;
    let currentUnpaidSessionId = null;

    // Gestion des sous-onglets paiements
    document.getElementById('viewPaidSessions').addEventListener('click', () => {
      switchPaymentView('Paid');
    });

    document.getElementById('viewUnpaidWithEmail').addEventListener('click', () => {
      switchPaymentView('Unpaid');
      loadUnpaidSessions();
    });

    function switchPaymentView(view) {
      // Désactiver tous les sous-onglets
      document.querySelectorAll('.sub-tab-button').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700');
      });
      document.querySelectorAll('.view-content').forEach(content => content.classList.add('hidden'));

      if (view === 'Paid') {
        const btn = document.getElementById('viewPaidSessions');
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        document.getElementById('viewPaidSessionsContent').classList.remove('hidden');
      } else if (view === 'Unpaid') {
        const btn = document.getElementById('viewUnpaidWithEmail');
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-300', 'text-gray-700');
        document.getElementById('viewUnpaidWithEmailContent').classList.remove('hidden');
      }
    }

    /**
     * Charger les sessions unpaid
     */
    async function loadUnpaidSessions(page = 1) {
      if (!adminKey) return;

      currentUnpaidPage = page;

      try {
        const response = await fetch('/api/admin-unpaid-sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({
            action: 'list',
            limit: 50,
            offset: (page - 1) * 50
          })
        });

        const data = await response.json();

        if (data.success) {
          renderUnpaidSessions(data.sessions || []);
          renderUnpaidPagination(data.pagination);
          loadUnpaidStats();
        } else {
          showError('Erreur: ' + (data.error || 'Erreur inconnue'));
        }
      } catch (error) {
        showError('Erreur chargement sessions non payées: ' + error.message);
      }
    }

    /**
     * Charger les statistiques unpaid
     */
    async function loadUnpaidStats() {
      if (!adminKey) return;

      try {
        const response = await fetch('/api/admin-unpaid-sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ action: 'stats' })
        });

        const data = await response.json();

        if (data.success && data.stats) {
          document.getElementById('unpaidWithEmailCount').textContent = data.stats.totalUnpaid || 0;
          document.getElementById('conversionRate').textContent = (data.stats.conversionRate || 0) + '%';
          document.getElementById('unpaidToday').textContent = data.stats.todayUnpaid || 0;
        }
      } catch (error) {
        console.error('Erreur chargement stats unpaid:', error);
      }
    }

    /**
     * Afficher les sessions unpaid dans le tableau
     */
    function renderUnpaidSessions(sessions) {
      const tbody = document.getElementById('unpaidSessionsList');
      tbody.innerHTML = '';

      if (sessions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
              Aucune session non payée trouvée
            </td>
          </tr>
        `;
        return;
      }

      sessions.forEach(session => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        const collectDate = session.email_collected_at
          ? new Date(session.email_collected_at).toLocaleDateString('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            })
          : '-';

        const expertiseDisplay = session.expertise
          ? (session.expertise === 'classique' ? 'Express' : 'Premium')
          : 'Non sélectionné';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${session.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${session.email}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expertiseDisplay}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${collectDate}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.messageCount || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.payment_attempts || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="showUnpaidSession('${session.session_uuid}')" class="text-blue-600 hover:text-blue-900">
              Voir conversation
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    /**
     * Pagination pour unpaid sessions
     */
    function renderUnpaidPagination(pagination) {
      const container = document.getElementById('unpaidPagination');
      container.innerHTML = '';

      if (!pagination || pagination.totalPages <= 1) return;

      for (let i = 1; i <= pagination.totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === pagination.page
          ? 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
          : 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
        btn.onclick = () => loadUnpaidSessions(i);
        container.appendChild(btn);
      }
    }

    /**
     * Afficher le détail d'une session unpaid
     */
    async function showUnpaidSession(sessionUuid) {
      if (!adminKey) return;

      currentUnpaidSessionId = sessionUuid;

      try {
        const response = await fetch('/api/admin-unpaid-sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({
            action: 'messages',
            sessionId: sessionUuid
          })
        });

        const data = await response.json();

        if (data.success) {
          const session = data.session;
          const messages = data.messages || [];

          // Remplir les infos session
          document.getElementById('unpaidModalEmail').textContent = session.email || 'Non renseigné';

          let expertiseText = 'Non sélectionné';
          if (session.expertise === 'classique') expertiseText = 'Analyse Express (29€)';
          else if (session.expertise === 'premium') expertiseText = 'Analyse Premium (49€)';
          document.getElementById('unpaidModalExpertise').textContent = expertiseText;

          const collectDate = session.email_collected_at
            ? new Date(session.email_collected_at).toLocaleString('fr-FR')
            : 'Non collecté';
          document.getElementById('unpaidModalCollectDate').textContent = collectDate;

          document.getElementById('unpaidModalAttempts').textContent = session.payment_attempts || 0;

          // Afficher les messages
          const messagesContainer = document.getElementById('unpaidModalMessages');
          messagesContainer.innerHTML = '';

          if (messages.length === 0) {
            messagesContainer.innerHTML = '<p class="text-gray-500">Aucun message dans cette conversation</p>';
          } else {
            messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = msg.role === 'user'
                ? 'bg-blue-50 p-4 rounded-lg'
                : 'bg-gray-50 p-4 rounded-lg';

              const roleDiv = document.createElement('div');
              roleDiv.className = `font-bold text-sm mb-2 ${msg.role === 'user' ? 'text-blue-900' : 'text-gray-700'}`;
              roleDiv.textContent = msg.role === 'user' ? 'Utilisateur' : 'Assistant';

              const contentDiv = document.createElement('div');
              contentDiv.className = 'text-gray-800 whitespace-pre-wrap';
              contentDiv.textContent = msg.content;

              const dateDiv = document.createElement('div');
              dateDiv.className = 'text-xs text-gray-500 mt-2';
              dateDiv.textContent = new Date(msg.created_at).toLocaleString('fr-FR');

              msgDiv.appendChild(roleDiv);
              msgDiv.appendChild(contentDiv);
              msgDiv.appendChild(dateDiv);
              messagesContainer.appendChild(msgDiv);
            });
          }

          // Afficher le modal
          document.getElementById('unpaidSessionModal').classList.remove('hidden');
        }
      } catch (error) {
        showError('Erreur chargement détail session: ' + error.message);
      }
    }

    /**
     * Fermer le modal unpaid session
     */
    function closeUnpaidSessionModal() {
      document.getElementById('unpaidSessionModal').classList.add('hidden');
      currentUnpaidSessionId = null;
    }

    /**
     * Exporter les sessions unpaid en CSV
     */
    function exportUnpaidSessions() {
      if (!adminKey) return;
      window.location.href = `/api/admin-unpaid-sessions?action=export&adminKey=${adminKey}`;
    }

    // ====================================
    // FONCTIONS ONGLET CONVERSATIONS
    // ====================================

    let allConversations = [];

    /**
     * Charger toutes les conversations (paid + unpaid)
     */
    async function loadAllConversations() {
      if (!adminKey) return;

      const tbody = document.getElementById('conversationsList');
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Chargement...</td></tr>';

      try {
        // Charger les deux sources en parallele
        const [paidRes, unpaidRes] = await Promise.all([
          fetch('/api/admin-payments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': adminKey },
            body: JSON.stringify({ action: 'list', adminKey, page: 1, limit: 500, paidOnly: false })
          }),
          fetch('/api/admin-unpaid-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': adminKey },
            body: JSON.stringify({ action: 'list', limit: 500, offset: 0 })
          })
        ]);

        const paidData = await paidRes.json();
        const unpaidData = await unpaidRes.json();

        const paidSessions = (paidData.success ? paidData.sessions || [] : []).map(s => ({
          id: s.id,
          sessionUuid: s.sessionUuid,
          email: s.email || 'Non renseigne',
          type: s.paid ? 'paid' : 'paid_pending',
          typeLabel: s.paid ? 'Payee' : 'En attente paiement',
          expertise: s.expertise,
          messageCount: s.messageCount || 0,
          date: s.paidAt || s.createdAt,
          source: 'paid'
        }));

        const unpaidSessions = (unpaidData.success ? unpaidData.sessions || [] : []).map(s => ({
          id: s.id,
          sessionUuid: s.session_uuid,
          email: s.email || 'Non renseigne',
          type: 'unpaid',
          typeLabel: 'Non payee',
          expertise: s.expertise,
          messageCount: s.messageCount || 0,
          date: s.email_collected_at || s.created_at,
          source: 'unpaid'
        }));

        // Fusionner et trier par date decroissante
        allConversations = [...paidSessions, ...unpaidSessions].sort((a, b) => {
          return new Date(b.date || 0) - new Date(a.date || 0);
        });

        // Mettre a jour les compteurs
        const paidCount = paidSessions.filter(s => s.type === 'paid').length;
        const unpaidCount = unpaidSessions.length;
        document.getElementById('convTotalCount').textContent = allConversations.length;
        document.getElementById('convPaidCount').textContent = paidCount;
        document.getElementById('convUnpaidCount').textContent = unpaidCount;

        filterConversations();
      } catch (error) {
        console.error('Erreur chargement conversations:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Erreur de chargement</td></tr>';
      }
    }

    /**
     * Filtrer et afficher les conversations
     */
    function filterConversations() {
      const filter = document.getElementById('convTypeFilter').value;
      let filtered = allConversations;

      if (filter === 'paid') {
        filtered = allConversations.filter(c => c.source === 'paid');
      } else if (filter === 'unpaid') {
        filtered = allConversations.filter(c => c.source === 'unpaid');
      }

      renderConversations(filtered);
    }

    /**
     * Afficher les conversations dans le tableau
     */
    function renderConversations(conversations) {
      const tbody = document.getElementById('conversationsList');
      tbody.innerHTML = '';

      if (conversations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Aucune conversation trouvee</td></tr>';
        return;
      }

      conversations.forEach(conv => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        const dateStr = conv.date
          ? new Date(conv.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
          : '-';

        let typeBadge = '';
        if (conv.type === 'paid') {
          typeBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Payee</span>';
        } else if (conv.type === 'paid_pending') {
          typeBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">En attente</span>';
        } else {
          typeBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">Non payee</span>';
        }

        let expertiseBadge = '-';
        if (conv.expertise === 'classique') {
          expertiseBadge = '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Express</span>';
        } else if (conv.expertise === 'premium') {
          expertiseBadge = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">Premium</span>';
        }

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${conv.email}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${typeBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${expertiseBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${conv.messageCount}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="showConversationDetail('${conv.sessionUuid}', '${conv.source}')" class="text-blue-600 hover:text-blue-900">
              Voir conversation
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    /**
     * Afficher le detail d'une conversation
     */
    async function showConversationDetail(sessionUuid, source) {
      if (!adminKey) return;

      try {
        let response;
        if (source === 'paid') {
          response = await fetch('/api/admin-payments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': adminKey },
            body: JSON.stringify({ action: 'messages', adminKey, sessionId: sessionUuid })
          });
        } else {
          response = await fetch('/api/admin-unpaid-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': adminKey },
            body: JSON.stringify({ action: 'messages', sessionId: sessionUuid })
          });
        }

        const data = await response.json();

        if (data.success) {
          const session = data.session;
          const messages = data.messages || [];

          document.getElementById('convModalEmail').textContent = session.email || 'Non renseigne';
          document.getElementById('convModalType').textContent = source === 'paid'
            ? (session.paid ? 'Session payee' : 'En attente de paiement')
            : 'Session non payee';

          let expertiseText = 'Non selectionne';
          if (session.expertise === 'classique') expertiseText = 'Analyse Express (29 EUR)';
          else if (session.expertise === 'premium') expertiseText = 'Analyse Premium (49 EUR)';
          document.getElementById('convModalExpertise').textContent = expertiseText;

          const dateStr = (source === 'paid' ? session.paidAt : session.email_collected_at)
            || session.createdAt || session.created_at;
          document.getElementById('convModalDate').textContent = dateStr
            ? new Date(dateStr).toLocaleString('fr-FR')
            : '-';

          // Afficher les messages
          const messagesContainer = document.getElementById('convModalMessages');
          messagesContainer.innerHTML = '';

          if (messages.length === 0) {
            messagesContainer.innerHTML = '<p class="text-gray-500">Aucun message dans cette conversation</p>';
          } else {
            messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = msg.role === 'user' ? 'bg-blue-50 p-4 rounded-lg' : 'bg-gray-50 p-4 rounded-lg';

              const roleDiv = document.createElement('div');
              roleDiv.className = `font-bold text-sm mb-2 ${msg.role === 'user' ? 'text-blue-900' : 'text-gray-700'}`;
              roleDiv.textContent = msg.role === 'user' ? 'Utilisateur' : 'Assistant';

              const contentDiv = document.createElement('div');
              contentDiv.className = 'text-gray-800 whitespace-pre-wrap';
              contentDiv.textContent = msg.content;

              const dateDiv = document.createElement('div');
              dateDiv.className = 'text-xs text-gray-500 mt-2';
              dateDiv.textContent = msg.created_at ? new Date(msg.created_at).toLocaleString('fr-FR') : '';

              msgDiv.appendChild(roleDiv);
              msgDiv.appendChild(contentDiv);
              msgDiv.appendChild(dateDiv);
              messagesContainer.appendChild(msgDiv);
            });
          }

          document.getElementById('conversationModal').classList.remove('hidden');
        }
      } catch (error) {
        showError('Erreur chargement conversation: ' + error.message);
      }
    }

    /**
     * Fermer le modal conversation
     */
    function closeConversationModal() {
      document.getElementById('conversationModal').classList.add('hidden');
    }
  </script>
</body>
</html>